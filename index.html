<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashBoard Bahagian - Sistem Laporan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e3a8a;
      --secondary: #1e40af;
      --accent: #3b82f6;
    }
    
    body { 
      font-family: 'Calibri', Arial, sans-serif; 
      font-size: 11pt; 
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      background-attachment: fixed;
    }
    
    .heading-font { 
      font-family: 'Calibri', Arial, sans-serif; 
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .glass-panel {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 1.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .report-header {
      text-align: left;
      margin-bottom: 2rem;
      padding: 1rem 0;
    }

    .report-header h1, .report-header h2, .report-header h3 {
      font-size: 12pt;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 0;
      line-height: 1.5;
    }
    
    .section-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }

    .section-label {
      display: inline-block;
      background: #1e3a8a;
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      table-layout: auto;
    }

    th, td {
      padding: 0.5rem;
      border: 1px solid #cbd5e1;
      text-align: center;
      font-size: 0.9rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      vertical-align: middle;
    }

    th {
      background: #1e3a8a;
      color: white;
      border: 1px solid #1e40af;
    }

    td:first-child {
      text-align: left;
      font-weight: 600;
      max-width: 250px;
    }

    .kumulatif-col { background: #fef3c7 !important; color: #92400e; font-weight: 700; }
    .jumlah-col { background: #dbeafe !important; color: #1e40af; font-weight: 700; }
    .jumlah-row { background: #dbeafe; border-top: 2px solid #1e40af !important; }
    .jumlah-row td { font-weight: 700; color: #1e40af; border-top: 2px solid #1e40af; }

    /* HANYA UBAH DI SINI UNTUK PRINT */
    @media print {
      @page { size: A4 portrait; margin: 1.5cm; }
      
      body { background: white !important; margin: 0; padding: 0; }
      .no-print { display: none !important; }
      main { width: 100% !important; padding: 0 !important; margin: 0 !important; }
      .report-page { 
        box-shadow: none !important; 
        padding: 0 !important;
        background: white !important;
        border-radius: 0 !important;
      }
      
      .section-container {
        background: white !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
        margin-bottom: 10px !important;
        page-break-before: always !important;
        page-break-inside: avoid !important;
      }
      
      .section-container:first-child {
        page-break-before: auto !important;
      }
      
      .section-label {
        background: transparent !important;
        color: black !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        margin-bottom: 5px !important;
        font-weight: bold !important;
      }
      
      /* Force table to wrap text properly */
      table { 
        table-layout: fixed !important; 
        width: 100% !important;
        border-collapse: collapse !important;
      }
      
      th, td { 
        word-wrap: break-word !important; 
        overflow-wrap: break-word !important; 
        white-space: normal !important; 
        font-size: 8pt !important;
        padding: 3px !important;
        line-height: 1.3 !important;
        border: 1px solid #000000 !important;
        text-align: left !important;
      }
      
      th {
        background: white !important;
        color: black !important;
        font-weight: bold !important;
        text-align: center !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* First column left align with more width */
      td:first-child, th:first-child {
        width: 30% !important;
        word-break: break-word !important;
        text-align: left !important;
      }
      
      /* Number columns center align */
      td:not(:first-child) {
        text-align: center !important;
      }
      
      /* Jumlah row */
      .jumlah-row {
        background: white !important;
        border-top: 2px solid #000000 !important;
      }
      
      .jumlah-row td {
        font-weight: bold !important;
        border: 1px solid #000000 !important;
      }
      
      /* CRITICAL: Hide input fields and show text only */
      td input {
        font-size: 0 !important;
        color: transparent !important;
        border: none !important;
        background: transparent !important;
        width: 100% !important;
      }
      
      /* For contenteditable cells */
      td[contenteditable] {
        word-wrap: break-word !important;
        word-break: break-word !important;
        white-space: normal !important;
      }
      
      /* GRAF - compact print layout matching screenshot */
      .chart-wrap {
        height: 220px !important;
        max-height: 220px !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 8px 0 !important;
        border: 1px solid #cbd5e1 !important;
        border-radius: 4px !important;
        background: #fff !important;
        page-break-inside: avoid;
      }

      canvas {
        display: block !important;
        width: 100% !important;
        height: 100% !important;
        max-height: 220px !important;
      }

      /* Dashboard charts (line/bar) ‚Äî keep them tighter too */
      .h-64 {
        height: 180px !important;
        max-height: 180px !important;
      }
      
      /* HIDE ULASAN LABEL ONLY - KEEP CONTENT */
      textarea { display: none !important; }
      
      /* Show ulasan content */
      .ulasan-print { 
        display: block !important;
        white-space: pre-wrap;
        margin-top: 10px;
        line-height: 1.5;
      }
      
      /* Hide ONLY the "ULASAN:" label */
      .ulasan-print-label { 
        display: none !important; 
      }
      
      /* Hide label that says "ULASAN" */
      label.block.text-sm.font-bold.text-slate-700.mb-2 {
        display: none !important;
      }
    }

    input:focus, textarea:focus, select:focus { 
      background-color: #f0f7ff !important; 
      outline: 3px solid var(--primary);
    }

    .animate-in { animation: slideInUp 0.6s ease forwards; }
    
    @keyframes slideInUp { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .ulasan-print, .ulasan-print-label { display: none; }
  </style>
</head>
<body>

  <!-- Login Page -->
  <div id="loginPage" class="fixed inset-0 z-50 bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900 flex items-center justify-center p-4">
    <div class="glass-panel w-full max-w-md p-8">
      <div class="text-center mb-8">
        <h1 class="heading-font text-3xl text-slate-800 mb-2">üîê LOGIN</h1>
        <p class="text-slate-600 text-sm">Sistem Laporan Bulanan</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-2">USERNAME</label>
          <input type="text" id="loginUsername" class="w-full p-3 border-2 border-slate-200 rounded-lg font-bold" placeholder="Masukkan username">
        </div>
        
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-2">PASSWORD</label>
          <input type="password" id="loginPassword" class="w-full p-3 border-2 border-slate-200 rounded-lg font-bold" placeholder="Masukkan password">
        </div>
        
        <button onclick="attemptLogin()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-black hover:scale-105 transition">
          MASUK
        </button>
        
        <button onclick="skipLoginAsViewer()" class="w-full py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold transition">
          üëÅÔ∏è VIEW ONLY
        </button>
        
        <div id="loginError" class="hidden p-3 bg-red-100 border-2 border-red-300 rounded-lg text-red-700 text-sm font-bold text-center">
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="flex min-h-screen hidden">
    <!-- Sidebar -->
    <aside class="w-72 bg-gradient-to-b from-slate-800 via-slate-900 to-slate-950 text-white flex-shrink-0 no-print border-r border-slate-700 shadow-2xl">
      <div class="p-8">
        <div class="mb-12">
          <h2 class="heading-font text-3xl mb-1 text-white">DashBoard</h2>
          <h3 class="heading-font text-2xl text-blue-300">Bahagian</h3>
          <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mt-2">Sistem Laporan Bulanan</p>
        </div>
        
        <nav class="space-y-2">
          <button onclick="setPage('dashboard-utama')" id="nav-dashboard-utama" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">monitoring</span> DASHBOARD UTAMA
          </button>
          <button onclick="setPage('settings')" id="nav-settings" class="w-full text-left p-4 rounded-xl flex items-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 font-black text-sm">
            <span class="material-symbols-outlined">settings</span> TETAPAN
          </button>
          <button onclick="setPage('report')" id="nav-report" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">description</span> LAPORAN
          </button>
          <button onclick="setPage('summary')" id="nav-summary" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">table_chart</span> DATA TAHUNAN
          </button>
          <button onclick="setPage('archive')" id="nav-archive" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">archive</span> ARKIB
          </button>
          <button onclick="setPage('users')" id="nav-users" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            ‚öôÔ∏è PENGURUSAN PENGGUNA
          </button>
        </nav>

        <div class="mt-12 p-6 bg-slate-800/50 rounded-xl border border-slate-700">
          <h4 class="text-xs font-black uppercase text-slate-400 mb-3">Info Sistem</h4>
          <div class="space-y-2 text-xs text-slate-300">
            <div>üë§ User: <span id="sidebarUser" class="font-bold text-white">-</span></div>
            <div>üîë Role: <span id="sidebarRole" class="font-bold text-cyan-400">-</span></div>
            <div>üìä Seksyen: <span id="sidebarSections" class="font-bold text-white">0</span></div>
            <div>üìÖ Bulan: <span id="sidebarMonth" class="font-bold text-cyan-400">-</span></div>
            <div>üíæ Arkib: <span id="sidebarArchive" class="font-bold text-white">0</span></div>
          </div>
          <button onclick="logout()" class="mt-4 w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-xs">
            üö™ LOG KELUAR
          </button>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
      
      <!-- Dashboard Utama Page -->
      <div id="dashboard-utamaPage" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">üìä Dashboard Utama</h2>
          <select id="dashboardYearSelect" onchange="renderDashboardUtama()" class="p-3 rounded-xl font-bold bg-white border-2 border-white">
          </select>
        </div>

        <!-- Dashboard KPI Section -->
        <div class="mb-8">
          <h3 class="heading-font text-2xl text-white mb-4">üìà KPI Seksyen</h3>
          <div id="dashboardKPIGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <!-- Dashboard Graf Section -->
        <div>
          <h3 class="heading-font text-2xl text-white mb-4">üìä Graf Trend Tahunan</h3>
          <div id="dashboardChartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settingsPage" class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">‚öôÔ∏è TETAPAN ORGANISASI</h2>
          <button onclick="logout()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">
            üö™ LOG KELUAR
          </button>
        </div>
        
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Maklumat Header Laporan</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Bahagian / Unit</label>
              <input type="text" id="orgDepartment" value="BAHAGIAN SIRKULASI" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Nama Organisasi</label>
              <input type="text" id="orgName" value="PERPUSTAKAAN HAMZAH SENDUT" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Bulan</label>
                <select id="monthSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()"></select>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Tahun</label>
                <select id="yearSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()">
                  <option>2026</option><option>2025</option><option>2024</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
            <div class="flex items-start gap-3">
              <span class="material-symbols-outlined text-blue-600">info</span>
              <div class="text-sm text-blue-800">
                <strong>Preview Header:</strong>
                <div class="mt-2 p-3 bg-white rounded border font-bold text-center">
                  <div id="headerPreview1">BAHAGIAN SIRKULASI</div>
                  <div id="headerPreview2">PERPUSTAKAAN HAMZAH SENDUT</div>
                  <div id="headerPreview3" class="text-blue-600">LAPORAN BULANAN JANUARI 2026</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass-panel p-8">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üì§ Upload Excel & Auto Generate</h3>
          <p class="text-slate-600 mb-4 text-sm">Upload fail Excel untuk auto-generate data. Format: Kolum pertama = Kategori, kolum seterusnya = Bulan (Januari-Disember)</p>
          
          <div class="flex gap-4 items-center mb-4">
            <input type="number" id="excelYear" placeholder="Tahun (e.g. 2026)" value="2026" class="w-32 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <input type="file" id="excelUpload" accept=".xlsx,.xls" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <button onclick="processExcelUpload()" class="px-6 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700">
              üìä PROSES EXCEL
            </button>
          </div>
          
          <div id="excelStatus" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>

        <div class="glass-panel p-8">
          <div class="flex justify-between items-center mb-6">
            <h3 class="heading-font text-2xl text-slate-800">Seksyen Laporan</h3>
            <button onclick="showAddSectionModal()" class="w-12 h-12 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-black hover:scale-105 transition text-2xl flex items-center justify-center" title="Tambah Seksyen">
              +
            </button>
          </div>

          <div id="sectionsList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Report Page -->
      <div id="reportPage" class="hidden">
        <div class="no-print mb-6 flex justify-end gap-3">
          <button onclick="window.print()" class="w-12 h-12 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition flex items-center justify-center" title="Print Laporan">
            <span class="material-symbols-outlined">print</span>
          </button>
          <button onclick="exportToWord()" class="w-12 h-12 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex items-center justify-center" title="Export ke Word">
            <span class="material-symbols-outlined">description</span>
          </button>
          <button onclick="exportToExcel()" class="w-12 h-12 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition flex items-center justify-center" title="Export ke Excel (CSV)">
            <span class="material-symbols-outlined">table_view</span>
          </button>
          <button onclick="saveToArchive()" class="w-12 h-12 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition flex items-center justify-center" title="Simpan ke Arkib">
            <span class="material-symbols-outlined">archive</span>
          </button>
        </div>

        <div class="report-page max-w-[1200px] mx-auto bg-white p-12 rounded-2xl shadow-2xl">
          <div class="report-header">
            <h1 id="reportHeader1">BAHAGIAN SIRKULASI</h1>
            <h2 id="reportHeader2">PERPUSTAKAAN HAMZAH SENDUT</h2>
            <h3 id="reportHeader3">LAPORAN BULANAN JANUARI 2026</h3>
          </div>

          <div id="reportContent"></div>
        </div>
      </div>

      <!-- Summary Page -->
      <div id="summaryPage" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">üìä DATA TAHUNAN</h2>
          <select id="summaryYearSelect" onchange="renderSummary()" class="p-3 rounded-xl font-bold bg-white border-2 border-white">
          </select>
        </div>
        <div id="summaryContent" class="space-y-8"></div>
      </div>

      <!-- Archive Page -->
      <div id="archivePage" class="hidden">
        <h2 class="heading-font text-4xl text-white mb-8">üóÑÔ∏è ARKIB LAPORAN</h2>
        <div id="archiveList" class="grid gap-4"></div>
      </div>

      <!-- Users Management Page -->
      <div id="usersPage" class="hidden max-w-4xl mx-auto">
        <h2 class="heading-font text-4xl text-white mb-8">‚öôÔ∏è PENGURUSAN PENGGUNA</h2>
        
        <!-- Change Password (for current user) -->
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üîê Tukar Password</h3>
          <div class="grid grid-cols-3 gap-4">
            <input type="password" id="currentPassword" placeholder="Password semasa" class="p-3 border-2 border-slate-200 rounded-lg font-bold">
            <input type="password" id="newPasswordField" placeholder="Password baru" class="p-3 border-2 border-slate-200 rounded-lg font-bold">
            <button onclick="changePassword()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              TUKAR PASSWORD
            </button>
          </div>
        </div>
        
        <!-- Add New User (Admin only) -->
        <div class="glass-panel p-8 mb-6" id="addUserSection">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">‚ûï Tambah Pengguna Baru (Admin Sahaja)</h3>
          
          <div class="flex gap-4 mb-4">
            <input type="text" id="newUsername" placeholder="Username baru" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <input type="password" id="newPassword" placeholder="Password" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <select id="newUserRole" class="p-3 border-2 border-slate-200 rounded-lg font-bold">
              <option value="viewer">Viewer</option>
              <option value="editor">Editor</option>
              <option value="admin">Admin</option>
            </select>
            <button onclick="addUser()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              + TAMBAH
            </button>
          </div>
        </div>
        
        <!-- Users List -->
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üë• Senarai Pengguna</h3>
          <div id="usersList" class="space-y-2"></div>
        </div>
        
        <!-- Activity Log -->
        <div class="glass-panel p-8">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üìã Log Aktiviti (50 Terkini)</h3>
          <div id="activityLogList" class="space-y-1 max-h-96 overflow-y-auto text-sm"></div>
        </div>
      </div>

    </main>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
    const sectionLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    
    // User authentication
    let users = JSON.parse(localStorage.getItem('phs_users')) || [
      { username: 'admin', password: 'admin123', role: 'admin' },
      { username: 'editor', password: 'edit123', role: 'editor' }
    ];
    let currentUser = null;
    let activityLog = JSON.parse(localStorage.getItem('phs_activity_log')) || [];
    
    let settings = JSON.parse(localStorage.getItem('phs_template_settings')) || {
      department: 'BAHAGIAN SIRKULASI',
      orgName: 'PERPUSTAKAAN HAMZAH SENDUT',
      month: 'Januari',
      year: '2026'
    };

    let sections = JSON.parse(localStorage.getItem('phs_template_sections')) || [];
    let persistentData = JSON.parse(localStorage.getItem('phs_template_persistent')) || {};
    let archive = JSON.parse(localStorage.getItem('phs_template_archive')) || [];

    function attemptLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      const user = users.find(u => u.username === username && u.password === password);
      
      if(user) {
        currentUser = user;
        logActivity(`${username} logged in as ${user.role}`);
        
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
        
        // Apply restrictions based on role
        if(user.role === 'viewer') {
          applyViewerRestrictions();
        } else if(user.role === 'editor') {
          applyEditorRestrictions();
        }
        
        init();
        setPage('dashboard-utama');
      } else {
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = '‚ùå Username atau password salah!';
        errorDiv.classList.remove('hidden');
      }
    }
    
    function skipLoginAsViewer() {
      currentUser = { username: 'Guest Viewer', role: 'viewer' };
      logActivity('Guest viewer accessed system');
      
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      applyViewerRestrictions();
      init();
      setPage('dashboard-utama');
    }
    
    function logActivity(action) {
      const entry = {
        timestamp: new Date().toISOString(),
        user: currentUser?.username || 'Unknown',
        action: action
      };
      activityLog.unshift(entry);
      
      // Keep only last 100 entries
      if(activityLog.length > 100) {
        activityLog = activityLog.slice(0, 100);
      }
      
      localStorage.setItem('phs_activity_log', JSON.stringify(activityLog));
    }
    
    function applyViewerRestrictions() {
      // Hide navigation buttons except Dashboard and Data Tahunan
      const navButtons = {
        'nav-settings': true,
        'nav-report': true,
        'nav-archive': true,
        'nav-users': true
      };
      
      Object.keys(navButtons).forEach(id => {
        const btn = document.getElementById(id);
        if(btn) btn.style.display = 'none';
      });
      
      // Add a flag to check if user is viewer
      window.isViewer = true;
      
      // Redirect to dashboard if trying to access restricted pages
      setTimeout(() => {
        const currentPage = document.querySelector('main > div:not(.hidden)');
        if(currentPage) {
          const pageId = currentPage.id;
          if(pageId !== 'dashboard-utamaPage' && pageId !== 'summaryPage') {
            setPage('dashboard-utama');
          }
        }
      }, 100);
    }
    
    function applyEditorRestrictions() {
      // Editors can edit but not manage users
      const usersNav = document.getElementById('nav-users');
      if(usersNav) usersNav.style.display = 'none';
      
      window.isEditor = true;
    }
    
    function logout() {
      if(confirm('Log keluar dari sistem?')) {
        currentUser = null;
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      }
    }
    
    function addUser() {
      if(currentUser.role !== 'admin') {
        alert('Hanya admin boleh menambah pengguna!');
        return;
      }
      
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const role = document.getElementById('newUserRole').value;
      
      if(!username || !password) {
        alert('Sila isi username dan password!');
        return;
      }
      
      if(users.find(u => u.username === username)) {
        alert('Username sudah wujud!');
        return;
      }
      
      users.push({ username, password, role });
      localStorage.setItem('phs_users', JSON.stringify(users));
      logActivity(`Admin added new user: ${username} (${role})`);
      
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
      
      renderUsersList();
      alert('‚úÖ Pengguna berjaya ditambah!');
    }
    
    function deleteUser(username) {
      if(currentUser.role !== 'admin') {
        alert('Hanya admin boleh memadam pengguna!');
        return;
      }
      
      if(username === 'admin') {
        alert('Tidak boleh padam admin utama!');
        return;
      }
      
      if(confirm(`Padam pengguna "${username}"?`)) {
        users = users.filter(u => u.username !== username);
        localStorage.setItem('phs_users', JSON.stringify(users));
        logActivity(`Admin deleted user: ${username}`);
        renderUsersList();
      }
    }
    
    function changePassword() {
      const currentPass = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPasswordField').value;
      
      if(!currentPass || !newPass) {
        alert('Sila isi kedua-dua field!');
        return;
      }
      
      if(currentUser.password !== currentPass) {
        alert('‚ùå Password semasa salah!');
        return;
      }
      
      if(newPass.length < 6) {
        alert('‚ùå Password baru mestilah sekurang-kurangnya 6 aksara!');
        return;
      }
      
      // Update password
      const userIndex = users.findIndex(u => u.username === currentUser.username);
      if(userIndex !== -1) {
        users[userIndex].password = newPass;
        currentUser.password = newPass;
        localStorage.setItem('phs_users', JSON.stringify(users));
        logActivity(`${currentUser.username} changed password`);
        
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPasswordField').value = '';
        
        alert('‚úÖ Password berjaya ditukar!');
      }
    }
    
    function renderActivityLog() {
      const container = document.getElementById('activityLogList');
      if(!container) return;
      
      if(activityLog.length === 0) {
        container.innerHTML = '<p class="text-slate-500 italic">Tiada aktiviti lagi</p>';
        return;
      }
      
      container.innerHTML = activityLog.slice(0, 50).map(entry => {
        const date = new Date(entry.timestamp);
        const timeStr = date.toLocaleString('ms-MY', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric',
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        return `
          <div class="p-2 bg-slate-50 rounded border-l-4 border-blue-400">
            <span class="font-bold text-blue-600">${timeStr}</span> | 
            <span class="text-slate-600">${entry.user}</span>: 
            <span class="text-slate-800">${entry.action}</span>
          </div>
        `;
      }).join('');
    }
    
    function renderUsersList() {
      const container = document.getElementById('usersList');
      if(!container) return;
      
      const roleIcons = {
        'admin': 'üëë',
        'editor': '‚úèÔ∏è',
        'viewer': 'üë§'
      };
      
      const roleColors = {
        'admin': 'text-purple-600',
        'editor': 'text-blue-600',
        'viewer': 'text-slate-600'
      };
      
      container.innerHTML = users.map(user => `
        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg border-2 border-slate-200">
          <div class="flex items-center gap-4">
            <span class="text-2xl">${roleIcons[user.role] || 'üë§'}</span>
            <div>
              <div class="font-bold text-slate-800">${user.username}</div>
              <div class="text-xs ${roleColors[user.role] || 'text-slate-500'} uppercase font-bold">${user.role}</div>
            </div>
          </div>
          ${user.username !== 'admin' && currentUser?.role === 'admin' ? `
            <button onclick="deleteUser('${user.username}')" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold text-sm hover:bg-red-600">
              PADAM
            </button>
          ` : '<span class="text-xs text-slate-400">Protected</span>'}
        </div>
      `).join('');
      
      // Hide add user section if not admin
      const addUserSection = document.getElementById('addUserSection');
      if(addUserSection && currentUser?.role !== 'admin') {
        addUserSection.style.display = 'none';
      }
    }

    function init() {
      // Setup month selector
      const mS = document.getElementById('monthSelect');
      mS.innerHTML = ''; // Clear existing options first
      months.forEach(m => mS.options.add(new Option(m, m)));
      mS.value = settings.month;
      document.getElementById('yearSelect').value = settings.year;

      // Setup dashboard year selector
      const dashYearSelect = document.getElementById('dashboardYearSelect');
      if(dashYearSelect) {
        dashYearSelect.innerHTML = ''; // Clear first
        const currentYear = new Date().getFullYear();
        for(let y = currentYear - 5; y <= currentYear + 5; y++) {
          dashYearSelect.options.add(new Option(y, y));
        }
        dashYearSelect.value = settings.year;
      }
      
      // Setup summary year selector
      const summaryYearSelect = document.getElementById('summaryYearSelect');
      if(summaryYearSelect) {
        summaryYearSelect.innerHTML = ''; // Clear first
        const currentYear = new Date().getFullYear();
        for(let y = currentYear - 5; y <= currentYear + 5; y++) {
          summaryYearSelect.options.add(new Option(y, y));
        }
        summaryYearSelect.value = settings.year;
      }

      // Load settings
      document.getElementById('orgDepartment').value = settings.department;
      document.getElementById('orgName').value = settings.orgName;

      // Update month display
      const monthDisplay = document.getElementById('month-display');
      if(monthDisplay) monthDisplay.textContent = settings.month;

      // Render users list if admin
      if(currentUser && currentUser.role === 'admin') {
        renderUsersList();
      }

      updateHeaderPreview();
      renderSectionsList();
      updateSidebar();
    }
    
    // Add Enter key support for login
    document.addEventListener('DOMContentLoaded', function() {
      const loginPassword = document.getElementById('loginPassword');
      if(loginPassword) {
        loginPassword.addEventListener('keypress', function(e) {
          if(e.key === 'Enter') {
            attemptLogin();
          }
        });
      }
    });

    function renderDashboardUtama() {
      const selectedYear = document.getElementById('dashboardYearSelect')?.value || settings.year;
      const selectedMonth = settings.month;

      // Check if there's any data
      const hasData = sections.length > 0 && sections.some(sec => 
        !sec.hidden && sec.type !== 'ulasan-only' && sec.data[selectedMonth] && sec.data[selectedMonth].length > 0
      );

      // Calculate KPI for each section
      const kpiData = sections.filter(sec => !sec.hidden).map((sec, idx) => {
        let total = 0;
        if(sec.type === 'standard' && sec.data[selectedMonth]) {
          sec.data[selectedMonth].forEach(row => {
            total += row.val || 0;
          });
        } else if(sec.type === 'custom' && sec.data[selectedMonth]) {
          sec.data[selectedMonth].forEach(row => {
            if(row.values) {
              total += row.values.reduce((sum, v) => sum + v, 0);
            }
          });
        }
        return { 
          title: sec.title, 
          total,
          label: sectionLabels[idx]
        };
      });

      // Render KPI cards
      const kpiContainer = document.getElementById('dashboardKPIGrid');
      kpiContainer.innerHTML = '';
      
      const kpiColors = ['blue', 'emerald', 'purple', 'orange', 'pink', 'indigo', 'red', 'teal', 'yellow', 'cyan'];
      
      kpiData.forEach((kpi, idx) => {
        const colorClass = kpiColors[idx % kpiColors.length];
        const card = document.createElement('div');
        card.className = 'glass-panel p-6 hover:scale-105 transition';
        card.innerHTML = `
          <div class="text-xs text-slate-500 font-bold mb-1">${kpi.label}</div>
          <div class="text-sm text-slate-600 font-bold mb-2 truncate">${kpi.title}</div>
          <div class="heading-font text-3xl text-${colorClass}-600">${kpi.total}</div>
          <div class="text-xs text-slate-500 mt-2">Bulan: ${selectedMonth}</div>
        `;
        kpiContainer.appendChild(card);
      });

      // Render charts for each section
      const chartsContainer = document.getElementById('dashboardChartsGrid');
      chartsContainer.innerHTML = '';

      if(!hasData) {
        chartsContainer.innerHTML = `
          <div class="col-span-2 glass-panel p-12 text-center">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">insert_chart</span>
            <h3 class="heading-font text-2xl text-slate-600 mb-2">TIADA DATA</h3>
            <p class="text-slate-500 mb-6">Dashboard akan auto-update bila anda masukkan data dalam laporan.</p>
            <div class="space-y-2 text-sm text-slate-600">
              <p>üìù Pergi ke <strong>TETAPAN</strong> ‚Üí Tambah Seksyen</p>
              <p>üìä Pergi ke <strong>LAPORAN</strong> ‚Üí Masukkan Data</p>
              <p>üîÑ Dashboard akan refresh automatically</p>
            </div>
            <button onclick="setPage('settings')" class="mt-6 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-black hover:scale-105 transition">
              PERGI KE TETAPAN
            </button>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        if(sec.hidden || sec.type === 'ulasan-only') return;

        const card = document.createElement('div');
        card.className = 'glass-panel p-6 animate-in';
        card.style.animationDelay = `${idx * 0.1}s`;

        const chartId = `dash-chart-${sec.id}`;
        
        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="heading-font text-lg text-slate-800">${sectionLabels[idx]}. ${sec.title}</h3>
              <p class="text-xs text-slate-500 mt-1">Trend Tahunan ${selectedYear}</p>
            </div>
            <select onchange="changeDashChartType('${chartId}', this.value)" class="text-xs p-2 border-2 rounded-lg font-bold">
              <option value="line">Line</option>
              <option value="bar">Bar</option>
              <option value="area">Area</option>
            </select>
          </div>
          <div class="h-64">
            <canvas id="${chartId}"></canvas>
          </div>
        `;

        chartsContainer.appendChild(card);

        setTimeout(() => {
          if(sec.type === 'standard') {
            renderDashboardChart(sec, chartId);
          } else if(sec.type === 'custom') {
            renderDashboardChartCustom(sec, chartId);
          }
        }, 100);
      });
    }

    function renderDashboardChart(sec, chartId) {
      const ctx = document.getElementById(chartId);
      if(!ctx) return;

      const datasets = sec.data["Januari"].map((row, idx) => {
        const colors = ['#0047FF', '#FF3366', '#00D9FF', '#00E676', '#FFD600', '#9C27B0', '#FF6B00', '#00BFA5'];
        return {
          label: row.kategori,
          data: months.map(m => getVal(sec.id, m, row.kategori)),
          borderColor: colors[idx % colors.length],
          backgroundColor: colors[idx % colors.length] + '20',
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: false
        };
      });

      window['chart_' + chartId] = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: months,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          devicePixelRatio: 2,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { weight: 'bold', size: 10 },
                padding: 10,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { 
                display: false,
                drawBorder: true
              },
              border: {
                display: true,
                color: '#000000',
                width: 2
              },
              ticks: { 
                font: { weight: 'bold' },
                color: '#000000'
              }
            },
            x: {
              grid: { 
                display: false,
                drawBorder: true
              },
              border: {
                display: true,
                color: '#000000',
                width: 2
              },
              ticks: { 
                font: { weight: 'bold', size: 10 },
                color: '#000000',
                maxRotation: 90,
                minRotation: 90
              }
            }
          }
        }
      });
    }

    function renderDashboardChartCustom(sec, chartId) {
      const ctx = document.getElementById(chartId);
      if(!ctx) return;

      // For custom tables, show total per month
      const monthlyTotals = months.map(m => {
        return sec.data[m].reduce((sum, row) => {
          return sum + (row.values || []).reduce((a, b) => a + b, 0);
        }, 0);
      });

      window['chart_' + chartId] = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Total',
            data: monthlyTotals,
            backgroundColor: '#9C27B0',
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          devicePixelRatio: 2,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: {
                display: false,
                drawBorder: true
              },
              border: {
                display: true,
                color: '#000000',
                width: 2
              },
              ticks: {
                font: { weight: 'bold' },
                color: '#000000'
              }
            },
            x: {
              grid: {
                display: false,
                drawBorder: true
              },
              border: {
                display: true,
                color: '#000000',
                width: 2
              },
              ticks: {
                font: { weight: 'bold' },
                color: '#000000'
              }
            }
          }
        }
      });
    }

    function changeDashChartType(chartId, type) {
      const chart = window['chart_' + chartId];
      if(!chart) return;

      chart.config.type = type;
      
      // Adjust fill for area chart
      chart.data.datasets.forEach(dataset => {
        dataset.fill = (type === 'area');
      });

      chart.update();
    }

    function saveSettings() {
      settings.department = document.getElementById('orgDepartment').value;
      settings.orgName = document.getElementById('orgName').value;
      settings.month = document.getElementById('monthSelect').value;
      settings.year = document.getElementById('yearSelect').value;
      
      localStorage.setItem('phs_template_settings', JSON.stringify(settings));
      updateHeaderPreview();
      updateSidebar();
    }

    function autoSave() {
      localStorage.setItem('phs_template_sections', JSON.stringify(sections));
      localStorage.setItem('phs_template_persistent', JSON.stringify(persistentData));
      localStorage.setItem('phs_template_archive', JSON.stringify(archive));
      updateSidebar();
      
      // Auto-refresh dashboard if it's currently visible
      const dashboardPage = document.getElementById('dashboard-utamaPage');
      if(dashboardPage && !dashboardPage.classList.contains('hidden')) {
        renderDashboardUtama();
      }
    }

    function updateHeaderPreview() {
      const preview1 = document.getElementById('headerPreview1');
      const preview2 = document.getElementById('headerPreview2');
      const preview3 = document.getElementById('headerPreview3');
      
      if(preview1) preview1.textContent = settings.department;
      if(preview2) preview2.textContent = settings.orgName;
      if(preview3) preview3.textContent = `LAPORAN BULANAN ${settings.month.toUpperCase()} ${settings.year}`;

      // Update report headers
      const h1 = document.getElementById('reportHeader1');
      const h2 = document.getElementById('reportHeader2');
      const h3 = document.getElementById('reportHeader3');
      if(h1) h1.textContent = settings.department;
      if(h2) h2.textContent = settings.orgName;
      if(h3) h3.textContent = `LAPORAN BULANAN ${settings.month.toUpperCase()} ${settings.year}`;
    }

    function updateSidebar() {
      document.getElementById('sidebarSections').textContent = sections.length;
      document.getElementById('sidebarMonth').textContent = settings.month;
      document.getElementById('sidebarArchive').textContent = archive.length;
      
      if(currentUser) {
        document.getElementById('sidebarUser').textContent = currentUser.username;
        document.getElementById('sidebarRole').textContent = currentUser.role.toUpperCase();
      }
    }

    function addSection(type = 'standard') {
      const newSection = {
        id: 'sec_' + Date.now(),
        title: 'TAJUK SEKSYEN',
        type: type, // 'standard', 'custom', 'ulasan-only', 'jumlah'
        hidden: false, // New property for hiding sections
        data: {},
        customColumns: [] // For custom table type
      };

      if(type === 'standard') {
        months.forEach(m => {
          newSection.data[m] = [
            { kategori: 'Category 1', val: 0 },
            { kategori: 'Category 2', val: 0 }
          ];
        });
      } else if(type === 'custom') {
        // Custom table like Section C (Pusat, Wilayah, etc.)
        newSection.customColumns = ['Pusat', 'Wilayah', 'Buku Diimbas', 'Oleh BS', 'Rekod daripada BSTM', 'Drop Record', 'MISSING'];
        months.forEach(m => {
          newSection.data[m] = [
            { kategori: 'Item 1', values: [0, 0, 0, 0, 0, 0, 0] }
          ];
        });
      } else if(type === 'jumlah') {
        // JUMLAH type - no data entry, just shows totals
        newSection.data = {}; // Empty, will calculate from other sections
      }

      newSection.ulasan = {};
      months.forEach(m => newSection.ulasan[m] = '');

      sections.push(newSection);
      persistentData[newSection.id] = JSON.parse(JSON.stringify(newSection));
      
      renderSectionsList();
      autoSave();
    }

    function showAddSectionModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-3xl p-8">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Pilih Jenis Seksyen</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="addSection('standard'); this.closest('.fixed').remove();" 
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-blue-600 mb-3">table_chart</span>
              <div class="font-black text-lg mb-2">STANDARD</div>
              <div class="text-xs text-slate-600">Jadual + Graf + Ulasan</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen A, B)</div>
            </button>
            
            <button onclick="addSection('custom'); this.closest('.fixed').remove();" 
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-purple-600 mb-3">view_column</span>
              <div class="font-black text-lg mb-2">CUSTOM TABLE</div>
              <div class="text-xs text-slate-600">Kolum tersuai + Ulasan</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen C)</div>
            </button>
            
            <button onclick="addSection('ulasan-only'); this.closest('.fixed').remove();" 
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-orange-600 mb-3">notes</span>
              <div class="font-black text-lg mb-2">ULASAN SAHAJA</div>
              <div class="text-xs text-slate-600">Tiada jadual/graf</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen D)</div>
            </button>
          </div>

          <button onclick="this.closest('.fixed').remove();" 
                  class="mt-6 w-full py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">
            BATAL
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function renderSectionsList() {
      const container = document.getElementById('sectionsList');
      container.innerHTML = '';

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="text-center p-12 border-2 border-dashed border-slate-300 rounded-xl">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">inbox</span>
            <p class="text-slate-500 font-bold">Tiada seksyen. Klik "TAMBAH SEKSYEN" untuk mula.</p>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "border-2 border-slate-200 rounded-xl p-4 hover:border-blue-400 transition";
        
        const typeBadges = {
          'standard': '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">üìä STANDARD</span>',
          'custom': '<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">üîß CUSTOM</span>',
          'jumlah': '<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">üßÆ JUMLAH</span>',
          'ulasan-only': '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">üí¨ ULASAN</span>'
        };
        
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4 flex-1">
              <div class="text-2xl font-black text-blue-600">${sectionLabels[idx]}.</div>
              <input value="${sec.title}" 
                     oninput="sections[${idx}].title = this.value; persistentData['${sec.id}'].title = this.value; autoSave();"
                     class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold text-lg hover:border-blue-300 transition">
              ${typeBadges[sec.type || 'standard']}
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="toggleSectionVisibility(${idx})" class="p-2 hover:bg-slate-50 rounded-lg transition" title="${sec.hidden ? 'Tunjuk' : 'Sembunyi'} Seksyen">
                ${sec.hidden ? 'üëÅÔ∏è' : 'üôà'}
              </button>
              <button onclick="moveSection(${idx}, -1)" class="p-2 hover:bg-blue-50 rounded-lg transition" ${idx === 0 ? 'disabled opacity-30' : ''}>
                <span class="material-symbols-outlined text-blue-600">arrow_upward</span>
              </button>
              <button onclick="moveSection(${idx}, 1)" class="p-2 hover:bg-blue-50 rounded-lg transition" ${idx === sections.length-1 ? 'disabled opacity-30' : ''}>
                <span class="material-symbols-outlined text-blue-600">arrow_downward</span>
              </button>
              ${sec.type === 'custom' ? `<button onclick="editCustomColumns(${idx})" class="p-2 hover:bg-purple-50 rounded-lg transition" title="Edit Columns">
                <span class="material-symbols-outlined text-purple-600">view_column</span>
              </button>` : ''}
              <button onclick="deleteSection(${idx})" class="p-2 hover:bg-red-50 rounded-lg transition">
                <span class="material-symbols-outlined text-red-600">delete</span>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function moveSection(idx, dir) {
      if (idx + dir < 0 || idx + dir >= sections.length) return;
      [sections[idx], sections[idx+dir]] = [sections[idx+dir], sections[idx]];
      renderSectionsList();
      autoSave();
    }
    
    function toggleSectionVisibility(idx) {
      sections[idx].hidden = !sections[idx].hidden;
      persistentData[sections[idx].id].hidden = sections[idx].hidden;
      autoSave();
      renderSectionsList();
      renderReport();
    }

    function deleteSection(idx) {
      if(confirm(`Padam seksyen "${sections[idx].title}"?\n\nData akan dipadam dari laporan dan data tahunan.`)) {
        const secId = sections[idx].id;
        sections.splice(idx, 1);
        delete persistentData[secId];
        renderSectionsList();
        autoSave();
      }
    }

    function renderReport() {
      const container = document.getElementById('reportContent');
      container.innerHTML = '';
      updateHeaderPreview();

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="text-center p-12">
            <p class="text-slate-500 font-bold text-lg">Tiada seksyen untuk dipaparkan.</p>
            <p class="text-slate-400 text-sm mt-2">Pergi ke TETAPAN untuk tambah seksyen.</p>
          </div>
        `;
        return;
      }

      const m = settings.month;
      const mIdx = months.indexOf(m);

      sections.forEach((sec, idx) => {
        // Skip hidden sections
        if(sec.hidden) return;
        const div = document.createElement('div');
        div.className = "section-container animate-in";
        div.style.animationDelay = `${idx * 0.1}s`;

        let content = '';

        // Header
        content += `
          <div class="flex justify-between items-start mb-4 no-print">
            <div class="section-label">${sectionLabels[idx]}. ${sec.title}</div>
          </div>
          <div class="print:block hidden mb-4">
            <div class="section-label">${sectionLabels[idx]}. ${sec.title}</div>
          </div>
        `;

        const secType = sec.type || 'standard';

        // STANDARD TYPE
        if(secType === 'standard') {
          let monthHeaders = '';
          for(let i = 0; i <= mIdx; i++) {
            monthHeaders += `<th>${months[i].toUpperCase()}</th>`;
          }

          const rows = sec.data[m].map((row, ri) => {
            let monthlyCols = '';
            let cumulative = 0;
            
            for(let i = 0; i <= mIdx; i++) {
              const val = getVal(sec.id, months[i], row.kategori);
              cumulative += val;
              monthlyCols += `<td><input type="number" value="${val}" 
                oninput="updateVal('${sec.id}', ${ri}, '${months[i]}', this.value)" 
                class="w-full text-center font-bold bg-transparent outline-none p-1"></td>`;
            }

            return `
              <tr>
                <td>
                  <input value="${row.kategori}" 
                         oninput="updateKategori('${sec.id}', ${ri}, this.value)"
                         class="w-full font-bold bg-transparent outline-none p-1">
                </td>
                ${monthlyCols}
                <td class="kumulatif-col">${cumulative}</td>
                <td class="no-print">
                  <button onclick="removeRow('${sec.id}', ${ri})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
                </td>
              </tr>
            `;
          }).join('');

          // Calculate JUMLAH row
          let jumlahRow = '<tr class="jumlah-row"><td class="font-black text-left">JUMLAH</td>';
          for(let i = 0; i <= mIdx; i++) {
            const monthTotal = sec.data[m].reduce((sum, row) => {
              return sum + getVal(sec.id, months[i], row.kategori);
            }, 0);
            jumlahRow += `<td class="jumlah-col">${monthTotal}</td>`;
          }
          // Kumulatif total
          const kumulatifTotal = sec.data[m].reduce((sum, row) => {
            let rowCumulative = 0;
            for(let i = 0; i <= mIdx; i++) {
              rowCumulative += getVal(sec.id, months[i], row.kategori);
            }
            return sum + rowCumulative;
          }, 0);
          jumlahRow += `<td class="jumlah-col">${kumulatifTotal}</td><td class="no-print"></td></tr>`;

          content += `
            <table>
              <thead>
                <tr>
                  <th class="text-left">KATEGORI</th>
                  ${monthHeaders}
                  <th class="bg-orange-700">KUMULATIF</th>
                  <th class="no-print w-10"></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${jumlahRow}
              </tbody>
            </table>

            <button onclick="addRow('${sec.id}')" class="no-print mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">
              + TAMBAH BARIS
            </button>

            <div class="mt-6">
              <div class="chart-wrap" style="height:280px; background:#f8fafc; border-radius:0.75rem; border:2px solid #e2e8f0; margin-bottom:1rem;">
                <canvas id="chart-${sec.id}"></canvas>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">ULASAN</label>
                <textarea 
                  oninput="updateUlasan('${sec.id}', this.value)" 
                  class="w-full h-40 p-4 border-2 border-slate-200 rounded-xl resize-none"
                  placeholder="Tulis ulasan di sini...">${sec.ulasan[m] || ''}</textarea>
                
                <!-- Print version of ulasan -->
                <div class="ulasan-print-label">ULASAN:</div>
                <div class="ulasan-print">${(sec.ulasan[m] || 'Tiada ulasan').replace(/\n/g, '<br>')}</div>
              </div>
            </div>
          `;
        }

        // CUSTOM TABLE TYPE
        else if(secType === 'custom') {
          const customCols = sec.customColumns || [];
          const colHeaders = customCols.map(col => `<th>${col}</th>`).join('');

          const rows = sec.data[m].map((row, ri) => {
            const vals = row.values || [];
            const cells = vals.map((v, ci) => `
              <td><input type="number" value="${v}" 
                    oninput="updateCustomVal('${sec.id}', ${ri}, ${ci}, this.value)"
                    class="w-full text-center font-bold bg-transparent outline-none p-1"></td>
            `).join('');

            return `
              <tr>
                <td>
                  <input value="${row.kategori}" 
                         oninput="updateKategori('${sec.id}', ${ri}, this.value)"
                         class="w-full font-bold bg-transparent outline-none p-1">
                </td>
                ${cells}
                <td class="no-print">
                  <button onclick="removeRow('${sec.id}', ${ri})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
                </td>
              </tr>
            `;
          }).join('');

          // Calculate JUMLAH row for custom table
          let jumlahRow = '<tr class="jumlah-row"><td class="text-left font-bold">JUMLAH</td>';
          customCols.forEach((col, ci) => {
            const total = sec.data[m].reduce((sum, row) => sum + (row.values[ci] || 0), 0);
            jumlahRow += `<td class="text-center font-bold">${total}</td>`;
          });
          jumlahRow += '<td class="no-print"></td></tr>';

          content += `
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th class="text-left">KATEGORI</th>
                    ${colHeaders}
                    <th class="no-print w-10"></th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                  ${jumlahRow}
                </tbody>
              </table>
            </div>

            <div class="no-print flex gap-2 mt-2">
              <button onclick="addRowCustom('${sec.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">
                + TAMBAH BARIS
              </button>
              <button onclick="editCustomColumns(${idx})" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-bold text-sm hover:bg-purple-700">
                <span class="material-symbols-outlined text-sm">edit</span> EDIT KOLUM
              </button>
            </div>

            <div class="mt-6">
              <label class="block text-sm font-bold text-slate-700 mb-2">ULASAN</label>
              <textarea 
                oninput="updateUlasan('${sec.id}', this.value)" 
                class="w-full h-40 p-4 border-2 border-slate-200 rounded-xl resize-none"
                placeholder="Tulis ulasan di sini...">${sec.ulasan[m] || ''}</textarea>
              
              <!-- Print version of ulasan -->
              <div class="ulasan-print-label">ULASAN:</div>
              <div class="ulasan-print">${(sec.ulasan[m] || 'Tiada ulasan').replace(/\n/g, '<br>')}</div>
            </div>
          `;
        }

        // ULASAN ONLY TYPE
        else if(secType === 'ulasan-only') {
          content += `
            <div class="mt-4">
              <label class="block text-sm font-bold text-slate-700 mb-2">ULASAN</label>
              <textarea 
                oninput="updateUlasan('${sec.id}', this.value)" 
                class="w-full h-64 p-4 border-2 border-slate-200 rounded-xl resize-none"
                placeholder="Tulis ulasan dan maklumat tambahan di sini...">${sec.ulasan[m] || ''}</textarea>
              
              <!-- Print version of ulasan -->
              <div class="ulasan-print-label">ULASAN:</div>
              <div class="ulasan-print">${(sec.ulasan[m] || 'Tiada ulasan').replace(/\n/g, '<br>')}</div>
            </div>
          `;
        }

        // JUMLAH TYPE
        else if(secType === 'jumlah') {
          // Calculate totals from all standard sections
          let grandTotals = {};
          months.forEach(month => grandTotals[month] = 0);

          sections.forEach(s => {
            if(s.type === 'standard' && s.data[m]) {
              s.data[m].forEach(row => {
                months.forEach(month => {
                  grandTotals[month] += getVal(s.id, month, row.kategori);
                });
              });
            }
          });

          let jumlahHeaders = '';
          let jumlahCells = '';
          let kumulatifTotal = 0;

          for(let i = 0; i <= mIdx; i++) {
            jumlahHeaders += `<th>${months[i].toUpperCase()}</th>`;
            jumlahCells += `<td class="text-center font-black text-lg">${grandTotals[months[i]]}</td>`;
            kumulatifTotal += grandTotals[months[i]];
          }

          content += `
            <table>
              <thead>
                <tr>
                  <th class="text-left">BULAN</th>
                  ${jumlahHeaders}
                  <th class="bg-orange-700">KUMULATIF</th>
                </tr>
              </thead>
              <tbody>
                <tr class="jumlah-row">
                  <td class="font-black text-left">JUMLAH KESELURUHAN</td>
                  ${jumlahCells}
                  <td class="kumulatif-col text-center font-black text-lg">${kumulatifTotal}</td>
                </tr>
              </tbody>
            </table>
            <div class="mt-4 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
              <p class="text-xs text-blue-800"><strong>Nota:</strong> Jadual ini auto-calculate jumlah daripada semua seksyen standard.</p>
            </div>
          `;
        }

        div.innerHTML = content;
        container.appendChild(div);
        
        if(secType === 'standard') {
          setTimeout(() => renderChart(sec), 100);
        }
      });
    }

    function getVal(secId, month, kategori) {
      const sec = persistentData[secId];
      if(!sec || !sec.data[month]) return 0;
      const row = sec.data[month].find(r => r.kategori === kategori);
      return row ? row.val : 0;
    }

    function updateVal(secId, rowIdx, month, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec && sec.data[month][rowIdx]) {
        sec.data[month][rowIdx].val = Number(val);
        persistentData[secId].data[month][rowIdx].val = Number(val);
        autoSave();
        renderReport();
      }
    }

    function updateKategori(secId, rowIdx, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        months.forEach(m => {
          if(sec.data[m][rowIdx]) {
            sec.data[m][rowIdx].kategori = val;
            persistentData[secId].data[m][rowIdx].kategori = val;
          }
        });
        autoSave();
      }
    }

    function updateUlasan(secId, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        sec.ulasan[settings.month] = val;
        persistentData[secId].ulasan[settings.month] = val;
        autoSave();
        
        // Update print version
        const printDivs = document.querySelectorAll('.ulasan-print');
        printDivs.forEach(div => {
          const parentSection = div.closest('.section-container');
          if(parentSection) {
            div.innerHTML = (val || 'Tiada ulasan').replace(/\n/g, '<br>');
          }
        });
      }
    }

    function updateCustomVal(secId, rowIdx, colIdx, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec && sec.data[settings.month][rowIdx]) {
        sec.data[settings.month][rowIdx].values[colIdx] = Number(val);
        persistentData[secId].data[settings.month][rowIdx].values[colIdx] = Number(val);
        autoSave();
      }
    }

    function addRowCustom(secId) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        const numCols = sec.customColumns.length;
        const newRow = { kategori: 'Item Baru', values: Array(numCols).fill(0) };
        months.forEach(m => {
          sec.data[m].push(JSON.parse(JSON.stringify(newRow)));
          persistentData[secId].data[m].push(JSON.parse(JSON.stringify(newRow)));
        });
        autoSave();
        renderReport();
      }
    }

    function editCustomColumns(idx) {
      const sec = sections[idx];
      const currentCols = sec.customColumns || [];
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-2xl p-8">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Edit Kolum Custom</h3>
          
          <div id="columnsList" class="space-y-2 mb-4"></div>
          
          <button onclick="addCustomColumn()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 mb-4">
            + TAMBAH KOLUM
          </button>

          <div class="flex gap-3">
            <button onclick="saveCustomColumns(${idx}); this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">
              SIMPAN
            </button>
            <button onclick="this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">
              BATAL
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      window.tempColumns = [...currentCols];
      renderColumnsList();
    }

    function renderColumnsList() {
      const container = document.getElementById('columnsList');
      if(!container) return;
      
      container.innerHTML = window.tempColumns.map((col, idx) => `
        <div class="flex items-center gap-2">
          <input value="${col}" 
                 oninput="window.tempColumns[${idx}] = this.value"
                 class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold"
                 placeholder="Nama Kolum ${idx + 1}">
          <button onclick="window.tempColumns.splice(${idx}, 1); renderColumnsList();" 
                  class="p-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      `).join('');
    }

    function addCustomColumn() {
      window.tempColumns.push('Kolum Baru');
      renderColumnsList();
    }

    function saveCustomColumns(idx) {
      const sec = sections[idx];
      sec.customColumns = [...window.tempColumns];
      persistentData[sec.id].customColumns = [...window.tempColumns];
      
      // Resize all data rows
      months.forEach(m => {
        sec.data[m].forEach(row => {
          const oldLen = row.values.length;
          const newLen = sec.customColumns.length;
          if(newLen > oldLen) {
            row.values.push(...Array(newLen - oldLen).fill(0));
          } else if(newLen < oldLen) {
            row.values = row.values.slice(0, newLen);
          }
        });
        persistentData[sec.id].data[m] = JSON.parse(JSON.stringify(sec.data[m]));
      });
      
      autoSave();
      renderSectionsList();
      renderReport();
    }

    function addRow(secId) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        months.forEach(m => {
          sec.data[m].push({ kategori: 'Kategori Baru', val: 0 });
          persistentData[secId].data[m].push({ kategori: 'Kategori Baru', val: 0 });
        });
        autoSave();
        renderReport();
      }
    }

    function removeRow(secId, rowIdx) {
      if(confirm('Padam baris ini?')) {
        const sec = sections.find(s => s.id === secId);
        if(sec) {
          months.forEach(m => {
            sec.data[m].splice(rowIdx, 1);
            persistentData[secId].data[m].splice(rowIdx, 1);
          });
          autoSave();
          renderReport();
        }
      }
    }

    function renderChart(sec) {
      const ctx = document.getElementById(`chart-${sec.id}`);
      if(!ctx) return;
      
      const m = settings.month;
      const data = sec.data[m] || [];
      
      // Determine rotation based on number of bars - FIXED LOGIC
      const shouldRotate = data.length > 5; // Changed from >4 to >5
      const rotation = shouldRotate ? 90 : 0;
      
      new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: data.map(r => r.kategori),
          datasets: [{
            label: sec.title,
            data: data.map(r => r.val),
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          devicePixelRatio: 2,
          layout: {
            padding: {
              left: 2,
              right: 2,
              top: 20,
              bottom: 2
            }
          },
          plugins: {
            legend: { display: false },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              offset: 2,
              font: { weight: 'bold', size: 13, family: 'Calibri, Arial, sans-serif' },
              color: '#1e40af',
              formatter: (val) => val || 0
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { 
                display: false,
                drawBorder: true
              },
              border: {
                display: true,
                color: '#000000',
                width: 2
              },
              ticks: { 
                font: { weight: 'bold', size: 12, family: 'Calibri, Arial, sans-serif' },
                color: '#000000',
                padding: 5
              }
            },
            x: { 
              grid: { 
                display: false,
                drawBorder: true
              },
              border: {
                display: true,
                color: '#000000',
                width: 2
              },
              ticks: { 
                font: { weight: 'bold', size: 10, family: 'Calibri, Arial, sans-serif' },
                color: '#000000',
                padding: 5,
                maxRotation: 0,
                minRotation: 0,
                autoSkip: false,
                // WRAP TEXT - Break long labels into multiple lines
                callback: function(value, index, ticks) {
                  const label = this.getLabelForValue(value);
                  const maxWidth = 15; // Max characters per line
                  
                  if (label.length <= maxWidth) return label;
                  
                  // Split by spaces and wrap
                  const words = label.split(' ');
                  const lines = [];
                  let currentLine = '';
                  
                  words.forEach(word => {
                    if ((currentLine + word).length <= maxWidth) {
                      currentLine += (currentLine ? ' ' : '') + word;
                    } else {
                      if (currentLine) lines.push(currentLine);
                      currentLine = word;
                    }
                  });
                  if (currentLine) lines.push(currentLine);
                  
                  return lines;
                }
              }
            }
          }
        }
      });
    }

    function renderSummary() {
      const container = document.getElementById('summaryContent');
      container.innerHTML = '';

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="glass-panel p-12 text-center">
            <p class="text-slate-500 font-bold">Tiada data untuk dipaparkan.</p>
          </div>
        `;
        return;
      }
      
      // Add year filter info
      const yearInfo = document.createElement('div');
      yearInfo.className = "glass-panel p-4 mb-6 text-center";
      yearInfo.innerHTML = `
        <p class="text-slate-700 font-bold">üìÖ Menunjukkan data untuk tahun: <span class="text-blue-600 text-xl">${settings.year}</span></p>
        <p class="text-xs text-slate-500 mt-2">Data dari tahun lain tidak akan digabungkan</p>
      `;
      container.appendChild(yearInfo);

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "glass-panel p-8 animate-in";
        div.style.animationDelay = `${idx * 0.1}s`;

        if(sec.type === 'ulasan-only') {
          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-4">${sectionLabels[idx]}. ${sec.title}</h3>
            <p class="text-slate-500 italic">Seksyen ini hanya mengandungi ulasan, tiada data jadual.</p>
          `;
          container.appendChild(div);
          return;
        }

        if(sec.type === 'custom') {
          // Custom table summary
          const customCols = sec.customColumns || [];
          const rows = sec.data["Januari"].map((r, ri) => {
            const kategori = r.kategori;
            const monthlyVals = months.map(m => {
              const mData = sec.data[m]?.find(row => row.kategori === kategori);
              return mData ? mData.values : Array(customCols.length).fill(0);
            });
            
            return `
              <tr class="hover:bg-slate-50">
                <td class="text-left font-bold">${kategori}</td>
                ${customCols.map((col, ci) => {
                  const monthVals = monthlyVals.map(vals => vals[ci]);
                  return monthVals.map(v => `<td>${v}</td>`).join('');
                }).join('')}
              </tr>
            `;
          }).join('');

          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-6">${sectionLabels[idx]}. ${sec.title} <span class="text-sm text-purple-600">(CUSTOM TABLE)</span></h3>
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th class="text-left">KATEGORI</th>
                    ${customCols.map(col => months.map(m => `<th>${col}<br><span class="text-[8px]">${m.substring(0,3)}</span></th>`).join('')).join('')}
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
          container.appendChild(div);
          return;
        }

        // Standard table summary
        const rows = sec.data["Januari"].map((r, ri) => {
          const mVals = months.map(m => getVal(sec.id, m, r.kategori));
          const avg = (mVals.reduce((a,b) => a+b, 0) / 12).toFixed(1);

          return `
            <tr class="hover:bg-slate-50">
              <td class="text-left font-bold">${r.kategori}</td>
              ${mVals.map((v, i) => {
                const prev = i > 0 ? mVals[i-1] : v;
                const color = v > prev ? 'bg-green-50 text-green-700' : v < prev ? 'bg-red-50 text-red-700' : '';
                return `<td class="${color}">${v}</td>`;
              }).join('')}
              <td class="font-bold bg-blue-50 text-blue-700">${avg}</td>
            </tr>
          `;
        }).join('');

        // JUMLAH row for summary
        let jumlahRow = '<tr class="jumlah-row"><td class="text-left">JUMLAH</td>';
        months.forEach(m => {
          const monthTotal = sec.data["Januari"].reduce((sum, r) => {
            return sum + getVal(sec.id, m, r.kategori);
          }, 0);
          jumlahRow += `<td>${monthTotal}</td>`;
        });
        const grandTotal = sec.data["Januari"].reduce((sum, r) => {
          return sum + months.reduce((mSum, m) => mSum + getVal(sec.id, m, r.kategori), 0);
        }, 0);
        const avgTotal = (grandTotal / 12).toFixed(1);
        jumlahRow += `<td>${avgTotal}</td></tr>`;

        div.innerHTML = `
          <h3 class="heading-font text-2xl text-slate-800 mb-6">${sectionLabels[idx]}. ${sec.title}</h3>
          <div class="overflow-x-auto">
            <table>
              <thead>
                <tr>
                  <th class="text-left">KATEGORI</th>
                  ${months.map(m => `<th>${m.substring(0,3).toUpperCase()}</th>`).join('')}
                  <th class="bg-blue-800">PURATA</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${jumlahRow}
              </tbody>
            </table>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function saveToArchive() {
      // Check if archive already exists for this month/year
      const existingIndex = archive.findIndex(item => 
        item.month === settings.month && 
        item.year === settings.year &&
        item.department === settings.department
      );
      
      const archiveData = {
        id: Date.now(),
        month: settings.month,
        year: settings.year,
        department: settings.department,
        orgName: settings.orgName,
        sections: JSON.parse(JSON.stringify(sections)),
        timestamp: new Date().toLocaleString('ms-MY')
      };
      
      if(existingIndex !== -1) {
        // Replace existing archive
        const confirmReplace = confirm(
          `Arkib untuk ${settings.month} ${settings.year} sudah wujud.\n\n` +
          `Klik OK untuk gantikan arkib lama.\n` +
          `Klik Cancel untuk simpan sebagai arkib baru.`
        );
        
        if(confirmReplace) {
          archive[existingIndex] = archiveData;
          autoSave();
          alert('‚úÖ Arkib berjaya dikemaskini!');
        } else {
          // Save as new with timestamp
          archiveData.id = Date.now();
          archive.push(archiveData);
          autoSave();
          alert('‚úÖ Arkib baru berjaya disimpan!');
        }
      } else {
        // Save new archive
        archive.push(archiveData);
        autoSave();
        alert('‚úÖ Laporan berjaya disimpan ke arkib!');
      }
      
      // Log activity
      logActivity(`Saved archive: ${settings.month} ${settings.year}`);
    }

    function renderArchive() {
      const container = document.getElementById('archiveList');
      container.innerHTML = '';

      if(archive.length === 0) {
        container.innerHTML = `
          <div class="glass-panel p-12 text-center">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">archive</span>
            <p class="text-slate-500 font-bold">Tiada arkib.</p>
          </div>
        `;
        return;
      }

      archive.slice().reverse().forEach((item, idx) => {
        const realIdx = archive.length - 1 - idx;
        const div = document.createElement('div');
        div.className = "glass-panel p-6 flex justify-between items-center animate-in";
        div.style.animationDelay = `${idx * 0.05}s`;

        div.innerHTML = `
          <div>
            <h3 class="heading-font text-lg text-slate-800">${item.department}</h3>
            <p class="text-sm text-slate-600">${item.orgName}</p>
            <p class="text-sm text-blue-600 font-bold mt-1">üìÖ ${item.month} ${item.year}</p>
            <p class="text-xs text-slate-400 mt-1">üíæ ${item.timestamp}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="loadArchive(${realIdx})" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              MUAT
            </button>
            <button onclick="deleteArchive(${realIdx})" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600">
              PADAM
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function loadArchive(idx) {
      if(confirm('Muat arkib ini? Data semasa akan diganti.')) {
        const item = archive[idx];
        settings.department = item.department;
        settings.orgName = item.orgName;
        settings.month = item.month;
        settings.year = item.year;
        sections = JSON.parse(JSON.stringify(item.sections));
        
        document.getElementById('orgDepartment').value = settings.department;
        document.getElementById('orgName').value = settings.orgName;
        document.getElementById('monthSelect').value = settings.month;
        document.getElementById('yearSelect').value = settings.year;
        
        saveSettings();
        renderSectionsList();
        setPage('settings');
      }
    }

    function deleteArchive(idx) {
      if(confirm('Padam arkib ini?')) {
        archive.splice(idx, 1);
        autoSave();
        renderArchive();
      }
    }

    function processExcelUpload() {
      const fileInput = document.getElementById('excelUpload');
      const file = fileInput.files[0];
      const year = document.getElementById('excelYear').value;
      const statusDiv = document.getElementById('excelStatus');
      
      if(!year || year < 2000 || year > 2100) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 border-2 border-red-300 text-red-700 font-bold';
        statusDiv.textContent = '‚ùå Sila masukkan tahun yang sah (2000-2100)!';
        statusDiv.classList.remove('hidden');
        return;
      }
      
      if(!file) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 border-2 border-red-300 text-red-700 font-bold';
        statusDiv.textContent = '‚ùå Sila pilih fail Excel terlebih dahulu!';
        statusDiv.classList.remove('hidden');
        return;
      }
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Get first sheet
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          
          // Convert to JSON
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          if(jsonData.length < 2) {
            throw new Error('Data tidak mencukupi dalam Excel');
          }
          
          // First row should be headers: [Kategori, Januari, Februari, ...]
          const headers = jsonData[0];
          const dataRows = jsonData.slice(1);
          
          // Verify headers
          const monthColumns = headers.slice(1);
          const validMonths = monthColumns.filter(h => months.includes(h));
          
          if(validMonths.length === 0) {
            throw new Error('Tiada kolum bulan yang sah dijumpai. Pastikan header menggunakan nama bulan: Januari, Februari, dll.');
          }
          
          // Create new section from Excel data
          const newSection = {
            id: 'sec_' + Date.now(),
            title: `${sheetName} (${year})`,
            type: 'standard',
            hidden: false,
            year: year,  // Store year metadata
            data: {},
            ulasan: {}
          };
          
          // Initialize data for each month
          months.forEach(m => {
            newSection.data[m] = [];
            newSection.ulasan[m] = '';
          });
          
          // Process each row
          dataRows.forEach(row => {
            const kategori = row[0];
            if(!kategori) return; // Skip empty rows
            
            // Add this category to each month with its value
            months.forEach((month, mIdx) => {
              const colIndex = headers.indexOf(month);
              const value = colIndex !== -1 ? (Number(row[colIndex]) || 0) : 0;
              
              newSection.data[month].push({
                kategori: String(kategori),
                val: value
              });
            });
          });
          
          // Add section to system
          sections.push(newSection);
          persistentData[newSection.id] = JSON.parse(JSON.stringify(newSection));
          
          logActivity(`Uploaded Excel: ${newSection.title} with ${dataRows.length} categories`);
          autoSave();
          renderSectionsList();
          
          statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 border-2 border-green-300 text-green-700 font-bold';
          statusDiv.textContent = `‚úÖ Excel berjaya diproses! Seksyen "${newSection.title}" telah ditambah dengan ${dataRows.length} kategori.`;
          statusDiv.classList.remove('hidden');
          
          // Clear file input
          fileInput.value = '';
          
        } catch(error) {
          statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 border-2 border-red-300 text-red-700 font-bold';
          statusDiv.textContent = `‚ùå Ralat: ${error.message}`;
          statusDiv.classList.remove('hidden');
        }
      };
      
      reader.onerror = function() {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 border-2 border-red-300 text-red-700 font-bold';
        statusDiv.textContent = '‚ùå Ralat membaca fail!';
        statusDiv.classList.remove('hidden');
      };
      
      reader.readAsArrayBuffer(file);
    }

    function exportToExcel() {
      try {
        const wb = XLSX.utils.book_new();
        
        if(sections.length === 0) {
          alert('‚ùå Tiada seksyen untuk di-export!');
          return;
        }
        
        sections.forEach((sec, idx) => {
          if(sec.hidden) return;
          
          const data = [
            [`${sectionLabels[idx]}. ${sec.title}`],
            ['Kategori', ...months, 'JUMLAH'],
          ];
          
          // Get first month that has data
          const firstDataMonth = months.find(m => sec.data[m] && sec.data[m].length > 0) || 'Januari';
          
          if(sec.data[firstDataMonth]) {
            sec.data[firstDataMonth].forEach(r => {
              const row = [r.kategori];
              const mVals = months.map(m => getVal(sec.id, m, r.kategori));
              const total = mVals.reduce((a,b) => a+b, 0);
              row.push(...mVals, total);
              data.push(row);
            });
          }
          
          const ws = XLSX.utils.aoa_to_sheet(data);
          XLSX.utils.book_append_sheet(wb, ws, sec.title.substring(0, 31));
        });
        
        XLSX.writeFile(wb, `Laporan_${settings.month}_${settings.year}.xlsx`);
        logActivity(`Exported to Excel: ${settings.month} ${settings.year}`);
        alert('‚úÖ Excel berjaya di-export!');
      } catch(error) {
        console.error('Excel export error:', error);
        alert('‚ùå Ralat export Excel: ' + error.message);
      }
    }
    
    function exportToWord() {
      // Get report content
      const reportHeader = `
        <div style="text-align: left; margin-bottom: 2cm;">
          <div style="font-weight: bold; font-size: 12pt; text-transform: uppercase;">${settings.department}</div>
          <div style="font-weight: bold; font-size: 12pt; text-transform: uppercase;">${settings.orgName}</div>
          <div style="font-weight: bold; font-size: 12pt; text-transform: uppercase;">LAPORAN BULANAN ${settings.month} ${settings.year}</div>
        </div>
      `;
      
      let content = reportHeader;
      
      sections.forEach((sec, idx) => {
        if(sec.hidden) return;
        
        content += `<div style="page-break-before: always; margin-top: 2cm;">`;
        content += `<div style="font-weight: bold; font-size: 11pt; margin-bottom: 0.5cm;">${sectionLabels[idx]}. ${sec.title}</div>`;
        
        if(sec.type === 'standard' || sec.type === 'custom') {
          content += `<table style="width: 100%; border-collapse: collapse; font-size: 9pt;">`;
          content += `<thead><tr>`;
          content += `<th style="border: 1px solid black; padding: 4px; background: white;">KATEGORI</th>`;
          
          if(sec.type === 'standard') {
            content += `<th style="border: 1px solid black; padding: 4px; background: white;">${settings.month.toUpperCase()}</th>`;
            content += `<th style="border: 1px solid black; padding: 4px; background: white;">KUMULATIF</th>`;
          } else {
            (sec.customColumns || []).forEach(col => {
              content += `<th style="border: 1px solid black; padding: 4px; background: white;">${col}</th>`;
            });
          }
          
          content += `</tr></thead><tbody>`;
          
          const m = settings.month;
          const data = sec.data[m] || [];
          
          data.forEach(row => {
            content += `<tr>`;
            content += `<td style="border: 1px solid black; padding: 4px; text-align: left;">${row.kategori}</td>`;
            
            if(sec.type === 'standard') {
              content += `<td style="border: 1px solid black; padding: 4px; text-align: center;">${row.val || 0}</td>`;
              const cumulative = months.slice(0, months.indexOf(m) + 1).reduce((sum, month) => {
                return sum + getVal(sec.id, month, row.kategori);
              }, 0);
              content += `<td style="border: 1px solid black; padding: 4px; text-align: center;">${cumulative}</td>`;
            } else {
              (row.values || []).forEach(val => {
                content += `<td style="border: 1px solid black; padding: 4px; text-align: center;">${val}</td>`;
              });
            }
            
            content += `</tr>`;
          });
          
          content += `</tbody></table>`;
          
          // Add chart as image if exists
          const canvas = document.getElementById(`chart-${sec.id}`);
          if(canvas) {
            try {
              const chartImage = canvas.toDataURL('image/png');
              content += `<div style="margin-top: 1cm; text-align: center;">`;
              content += `<img src="${chartImage}" style="max-width: 100%; height: auto;" />`;
              content += `</div>`;
            } catch(e) {
              console.log('Could not export chart:', e);
            }
          }
        }
        
        const ulasan = sec.ulasan[settings.month] || '';
        if(ulasan) {
          content += `<div style="margin-top: 1cm;">`;
          content += `<div>${ulasan.replace(/\n/g, '<br>')}</div>`;
          content += `</div>`;
        }
        
        content += `</div>`;
      });
      
      // Create Word document blob
      const htmlContent = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Laporan</title>
        <style>
          @page { margin: 2.5cm; }
          body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; }
          table { border-collapse: collapse; width: 100%; }
        </style>
        </head>
        <body>${content}</body>
        </html>
      `;
      
      const blob = new Blob(['\ufeff', htmlContent], {
        type: 'application/msword'
      });
      
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `Laporan_${settings.month}_${settings.year}.doc`;
      link.click();
      URL.revokeObjectURL(url);
      
      alert('‚úÖ Word document berjaya di-export!');
    }

    function setPage(page) {
      document.querySelectorAll('main > div[id$="Page"]').forEach(d => d.classList.add('hidden'));
      document.getElementById(page + 'Page').classList.remove('hidden');
      
      document.querySelectorAll('nav button').forEach(b => {
        b.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-blue-700', 'from-blue-500', 'to-blue-600', 'font-black');
        b.classList.add('hover:bg-slate-700/50', 'font-bold');
      });
      
      const btn = document.getElementById('nav-' + page);
      if(btn) {
        btn.classList.remove('hover:bg-slate-700/50', 'font-bold');
        btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-blue-700', 'font-black');
      }
      
      if(page === 'dashboard-utama') renderDashboardUtama();
      if(page === 'report') renderReport();
      if(page === 'summary') renderSummary();
      if(page === 'archive') renderArchive();
      if(page === 'users') {
        renderUsersList();
        renderActivityLog();
      }
    }

    init();
    
    // Print handler - replace inputs with text for proper wrapping
    window.addEventListener('beforeprint', function() {
      // Find all inputs in tables and replace with div
      document.querySelectorAll('td input, th input').forEach(input => {
        const value = input.value || '';
        const textDiv = document.createElement('div');
        textDiv.className = 'print-text-replacement';
        textDiv.textContent = value;
        
        // Check if this is first column (kategori)
        const isFirstCol = input.closest('td') && input.closest('td').cellIndex === 0;
        const alignment = isFirstCol ? 'left' : 'center';
        
        textDiv.style.cssText = `word-wrap: break-word; white-space: normal; text-align: ${alignment}; font-weight: 600; font-size: 8pt; line-height: 1.3;`;
        
        // Store original input for restoration
        input.dataset.printHidden = 'true';
        input.style.display = 'none';
        input.parentNode.insertBefore(textDiv, input);
      });
      
      // Handle contenteditable cells - force left align untuk kategori column
      document.querySelectorAll('td[contenteditable]').forEach(cell => {
        const isFirstCol = cell.cellIndex === 0;
        cell.style.wordWrap = 'break-word';
        cell.style.whiteSpace = 'normal';
        cell.style.wordBreak = 'break-word';
        cell.style.textAlign = isFirstCol ? 'left' : 'center';
      });
      
      // Hide ULASAN LABEL only - keep content visible
      // Hide textarea (input field)
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.style.display = 'none';
      });
      
      // Hide ONLY the label "ULASAN"
      document.querySelectorAll('label').forEach(label => {
        if(label.textContent.trim() === 'ULASAN') {
          label.style.display = 'none';
        }
      });
      
      // Hide "ULASAN:" prefix label
      document.querySelectorAll('.ulasan-print-label').forEach(el => {
        el.style.display = 'none';
      });
      
      // SHOW ulasan content
      document.querySelectorAll('.ulasan-print').forEach(el => {
        el.style.display = 'block';
      });
    });
    
    window.addEventListener('afterprint', function() {
      // Restore original inputs
      document.querySelectorAll('.print-text-replacement').forEach(div => {
        div.remove();
      });
      
      document.querySelectorAll('td input[data-print-hidden]').forEach(input => {
        input.style.display = '';
        delete input.dataset.printHidden;
      });
      
      // Restore contenteditable alignment
      document.querySelectorAll('td[contenteditable]').forEach(cell => {
        cell.style.textAlign = '';
      });
      
      // Restore labels and textarea
      document.querySelectorAll('textarea, label, .ulasan-print-label').forEach(el => {
        el.style.display = '';
      });
    });
  </script>
</body>
</html>
