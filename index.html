<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashBoard Bahagian - Sistem Laporan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0047FF;
      --secondary: #FF3366;
      --accent: #00D9FF;
    }
    
    body { 
      font-family: 'Outfit', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
    }
    
    .heading-font { 
      font-family: 'Archivo Black', sans-serif; 
      letter-spacing: -0.03em;
    }
    
    .glass-panel {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 1.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .report-header {
      text-align: left;
      margin-bottom: 2rem;
      padding: 1rem 0;
    }

    .report-header h1 {
      font-size: 12pt;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 0.2rem;
      line-height: 1.3;
    }

    .report-header h2 {
      font-size: 12pt;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 0.2rem;
      line-height: 1.3;
    }

    .report-header h3 {
      font-size: 12pt;
      font-weight: 700;
      text-transform: uppercase;
      line-height: 1.3;
      margin-top: 0.5rem;
    }
    
    .section-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }

    .section-label {
      display: inline-block;
      background: linear-gradient(135deg, #0047FF, #00D9FF);
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 900;
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    th {
      background: #1e293b;
      color: white;
      padding: 0.75rem;
      text-align: center;
      font-weight: 800;
      font-size: 0.75rem;
      text-transform: uppercase;
      border: 1px solid #334155;
    }

    td {
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    td:first-child {
      text-align: left;
      font-weight: 700;
    }

    .kumulatif-col {
      background: #fff7ed !important;
      color: #c2410c;
      font-weight: 900;
    }

    .jumlah-col {
      background: #fef3c7 !important;
      color: #a16207;
      font-weight: 900;
    }

    .jumlah-row {
      background: #fef3c7;
      border-top: 3px solid #a16207 !important;
    }

    .jumlah-row td {
      font-weight: 900;
      color: #a16207;
      border-top: 3px solid #a16207;
    }
    
    .ulasan {
      margin-top: 1rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      background: #f9f9f9;
    }
    
    .ulasan-title {
      font-weight: bold;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }

    @media print {
      @page {
        size: A4 portrait;
        margin: 1.5cm 2cm 1.5cm 2cm;
      }
      
      body { 
        background: white;
        margin: 0;
        padding: 0;
      }
      
      .no-print { display: none !important; }
      
      .report-page {
        padding: 0 !important;
        max-width: 100% !important;
        margin: 0 !important;
        box-shadow: none !important;
        border-radius: 0 !important;
      }
      
      .report-header {
        page-break-after: avoid;
        margin-bottom: 1cm;
        padding: 0;
        background: none;
        box-shadow: none;
        border-radius: 0;
        text-align: left;
      }
      
      .section-container { 
        page-break-before: always;
        page-break-inside: avoid;
        box-shadow: none !important;
        margin-bottom: 0;
        padding: 0 !important;
        border: none !important;
        background: white !important;
        border-radius: 0 !important;
      }
      
      .section-container:first-of-type {
        page-break-before: avoid;
      }
      
      .section-label {
        page-break-after: avoid;
        background: transparent !important;
        color: black !important;
        border: none !important;
        padding: 0.5rem 0 !important;
        font-size: 12pt !important;
        font-weight: bold !important;
      }
      
      table {
        page-break-inside: avoid;
        font-size: 10pt;
        border-collapse: collapse !important;
      }
      
      th {
        font-size: 9pt !important;
        padding: 0.4rem !important;
        border: 1px solid #000 !important;
      }
      
      td {
        font-size: 10pt !important;
        padding: 0.4rem !important;
        border: 1px solid #000 !important;
      }
      
      .jumlah-row td {
        border: 1px solid #000 !important;
        font-weight: 900 !important;
      }
      
      .chart-container {
        page-break-inside: avoid;
        page-break-after: avoid;
        max-height: 250px;
      }
      
      canvas {
        max-width: 100% !important;
        max-height: 250px !important;
      }
      
      textarea {
        display: none !important;
      }
      
      .ulasan {
        border: none !important;
        background: white !important;
        padding: 0.5rem 0 !important;
      }
      
      .ulasan-title {
        font-size: 11pt !important;
        margin-bottom: 0.3rem !important;
      }
      
      .print-ulasan-content {
        font-size: 10pt;
        line-height: 1.5;
        white-space: pre-wrap;
      }
      
      .chart-title {
        font-size: 10pt !important;
        font-weight: bold !important;
        text-align: center;
        margin-bottom: 0.5rem;
      }
    }

    input:focus, textarea:focus, select:focus { 
      background-color: #f0f7ff !important; 
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
  </style>
</head>
<body>

  <div id="app" class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-72 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 text-white flex-shrink-0 no-print border-r border-slate-700 shadow-2xl">
      <div class="p-8">
        <div class="mb-12">
          <h2 class="heading-font text-3xl mb-1 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-400">DashBoard</h2>
          <h3 class="heading-font text-2xl text-cyan-400">Bahagian</h3>
          <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mt-2">Sistem Laporan Bulanan</p>
        </div>
        
        <nav class="space-y-2">
          <button onclick="setPage('dashboard-utama')" id="nav-dashboard-utama" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">monitoring</span> DASHBOARD UTAMA
          </button>
          <button onclick="setPage('settings')" id="nav-settings" class="w-full text-left p-4 rounded-xl flex items-center gap-3 bg-gradient-to-r from-purple-600 to-pink-500 font-black text-sm">
            <span class="material-symbols-outlined">settings</span> TETAPAN
          </button>
          <button onclick="setPage('report')" id="nav-report" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">description</span> LAPORAN
          </button>
          <button onclick="setPage('summary')" id="nav-summary" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">table_chart</span> DATA TAHUNAN
          </button>
          <button onclick="setPage('archive')" id="nav-archive" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">archive</span> ARKIB
          </button>
        </nav>

        <div class="mt-12 p-6 bg-slate-800/50 rounded-xl border border-slate-700">
          <h4 class="text-xs font-black uppercase text-slate-400 mb-3">Info Sistem</h4>
          <div class="space-y-2 text-xs text-slate-300">
            <div>üìä Seksyen: <span id="sidebarSections" class="font-bold text-white">0</span></div>
            <div>üìÖ Bulan: <span id="sidebarMonth" class="font-bold text-cyan-400">-</span></div>
            <div>üíæ Arkib: <span id="sidebarArchive" class="font-bold text-white">0</span></div>
          </div>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
      
      <!-- Dashboard Utama Page -->
      <div id="dashboard-utamaPage" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">Dashboard Utama</h2>
          <select id="dashboardMonthSelect" onchange="renderDashboardUtama()" class="p-3 rounded-xl font-bold bg-white border-2 border-white">
          </select>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="glass-panel p-6 hover:scale-105 transition">
            <div class="text-sm text-slate-600 font-bold mb-2">Jumlah Bulan Ini</div>
            <div class="heading-font text-4xl text-blue-600 mb-2" id="kpi-total">0</div>
            <div class="flex items-center gap-2 text-sm">
              <span id="kpi-total-change" class="font-bold">+0%</span>
              <span class="text-slate-500" id="kpi-total-comparison">Dari bulan lepas</span>
            </div>
          </div>

          <div class="glass-panel p-6 hover:scale-105 transition">
            <div class="text-sm text-slate-600 font-bold mb-2">Purata Bulanan</div>
            <div class="heading-font text-4xl text-emerald-600 mb-2" id="kpi-avg">0</div>
            <div class="flex items-center gap-2 text-sm">
              <span class="text-slate-500">Purata tahun ini</span>
            </div>
          </div>

          <div class="glass-panel p-6 hover:scale-105 transition">
            <div class="text-sm text-slate-600 font-bold mb-2">Tertinggi</div>
            <div class="heading-font text-4xl text-purple-600 mb-2" id="kpi-max">0</div>
            <div class="flex items-center gap-2 text-sm">
              <span id="kpi-max-month" class="text-slate-500">-</span>
            </div>
          </div>

          <div class="glass-panel p-6 hover:scale-105 transition">
            <div class="text-sm text-slate-600 font-bold mb-2">Kumulatif</div>
            <div class="heading-font text-4xl text-orange-600 mb-2" id="kpi-cumulative">0</div>
            <div class="flex items-center gap-2 text-sm">
              <span class="text-slate-500">Sehingga bulan ini</span>
            </div>
          </div>
        </div>

        <!-- Charts Grid -->
        <div id="dashboardChartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
      </div>

      <!-- Settings Page -->
      <div id="settingsPage" class="max-w-4xl mx-auto">
        <h2 class="heading-font text-4xl text-white mb-8">‚öôÔ∏è TETAPAN ORGANISASI</h2>
        
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Maklumat Header Laporan</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Bahagian / Unit</label>
              <input type="text" id="orgDepartment" value="BAHAGIAN SIRKULASI" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Nama Organisasi</label>
              <input type="text" id="orgName" value="PERPUSTAKAAN HAMZAH SENDUT" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Bulan</label>
                <select id="monthSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()"></select>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Tahun</label>
                <select id="yearSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()">
                  <option>2026</option><option>2025</option><option>2024</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
            <div class="flex items-start gap-3">
              <span class="material-symbols-outlined text-blue-600">info</span>
              <div class="text-sm text-blue-800">
                <strong>Preview Header:</strong>
                <div class="mt-2 p-3 bg-white rounded border font-bold text-center">
                  <div id="headerPreview1">BAHAGIAN SIRKULASI</div>
                  <div id="headerPreview2">PERPUSTAKAAN HAMZAH SENDUT</div>
                  <div id="headerPreview3" class="text-blue-600">LAPORAN BULANAN JANUARI 2026</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass-panel p-8">
          <div class="flex justify-between items-center mb-6">
            <h3 class="heading-font text-2xl text-slate-800">Seksyen Laporan</h3>
            <button onclick="showAddSectionModal()" class="w-12 h-12 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-black hover:scale-105 transition flex items-center justify-center" title="Tambah Seksyen">
              <span class="material-symbols-outlined text-3xl">add</span>
            </button>
          </div>

          <div id="sectionsList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Report Page -->
      <div id="reportPage" class="hidden">
        <div class="no-print mb-6 flex justify-end gap-3">
          <button onclick="window.print()" class="w-12 h-12 bg-slate-700 text-white rounded-xl hover:bg-slate-800 transition flex items-center justify-center" title="Print">
            <span class="material-symbols-outlined">print</span>
          </button>
          <button onclick="exportToExcel()" class="w-12 h-12 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition flex items-center justify-center" title="Export Excel">
            <span class="material-symbols-outlined">download</span>
          </button>
          <button onclick="saveToArchive()" class="w-12 h-12 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition flex items-center justify-center" title="Simpan ke Arkib">
            <span class="material-symbols-outlined">save</span>
          </button>
        </div>

        <div class="report-page max-w-[1200px] mx-auto bg-white p-12 rounded-2xl shadow-2xl">
          <div class="report-header">
            <h2 id="reportHeader1">BAHAGIAN SIRKULASI</h2>
            <h2 id="reportHeader2">PERPUSTAKAAN HAMZAH SENDUT</h2>
            <h3 id="reportHeader3">LAPORAN BULANAN JANUARI 2026</h3>
          </div>

          <div id="reportContent"></div>
        </div>
      </div>

      <!-- Summary Page -->
      <div id="summaryPage" class="hidden">
        <h2 class="heading-font text-4xl text-white mb-8">üìä DATA TAHUNAN</h2>
        <div id="summaryContent" class="space-y-8"></div>
      </div>

      <!-- Archive Page -->
      <div id="archivePage" class="hidden">
        <h2 class="heading-font text-4xl text-white mb-8">üóÑÔ∏è ARKIB LAPORAN</h2>
        <div id="archiveList" class="grid gap-4"></div>
      </div>

    </main>
  </div>

  <script>
    function getSectionLabel(idx) {
      const mainSections = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P'];
      const section = sections[idx];
      
      // If this is a main section
      if(section.numberingStyle === 'main' || section.numberingStyle === 'auto') {
        // Count how many main sections we've had up to this point
        let mainCount = 0;
        for(let i = 0; i <= idx; i++) {
          if(sections[i].numberingStyle === 'main' || sections[i].numberingStyle === 'auto') {
            if(i === idx) return mainSections[mainCount];
            mainCount++;
          }
        }
        return mainSections[0];
      }
      
      // If this is a subsection
      if(section.numberingStyle === 'sub') {
        // Find the parent main section (look backwards)
        let parentLabel = 'A';
        let parentIdx = -1;
        
        for(let i = idx - 1; i >= 0; i--) {
          if(sections[i].numberingStyle === 'main' || sections[i].numberingStyle === 'auto') {
            parentIdx = i;
            // Count main sections up to parent
            let mainCount = 0;
            for(let j = 0; j <= i; j++) {
              if(sections[j].numberingStyle === 'main' || sections[j].numberingStyle === 'auto') {
                if(j === i) {
                  parentLabel = mainSections[mainCount];
                  break;
                }
                mainCount++;
              }
            }
            break;
          }
        }
        
        // Count subsections under the same parent
        let subNumber = 1;
        for(let i = parentIdx + 1; i < idx; i++) {
          if(sections[i].numberingStyle === 'sub') {
            // Check if this subsection belongs to the same parent
            let belongsToSameParent = true;
            for(let j = i - 1; j > parentIdx; j--) {
              if(sections[j].numberingStyle === 'main' || sections[j].numberingStyle === 'auto') {
                belongsToSameParent = false;
                break;
              }
            }
            if(belongsToSameParent) {
              subNumber++;
            }
          }
        }
        
        return `${parentLabel}.${subNumber}`;
      }
      
      // Fallback
      return mainSections[idx] || 'X';
    }
    const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
    const sectionLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    
    function initializeDefaultSections() {
      // Section A - Standard
      const secA = {
        id: 'sec_a_' + Date.now(),
        title: 'TAJUK',
        type: 'standard',
        data: {},
        customColumns: [],
        ulasan: {},
        numberingStyle: 'main'
      };
      months.forEach(m => {
        secA.data[m] = [
          { kategori: 'Category 1', val: 0 },
          { kategori: 'Category 2', val: 0 }
        ];
        secA.ulasan[m] = '';
      });
      
      // Section B - Standard
      const secB = {
        id: 'sec_b_' + (Date.now() + 1),
        title: 'TAJUK',
        type: 'standard',
        data: {},
        customColumns: [],
        ulasan: {},
        numberingStyle: 'main'
      };
      months.forEach(m => {
        secB.data[m] = [
          { kategori: 'Category 1', val: 0 },
          { kategori: 'Category 2', val: 0 }
        ];
        secB.ulasan[m] = '';
      });
      
      // Section C - Custom Table
      const secC = {
        id: 'sec_c_' + (Date.now() + 2),
        title: 'TAJUK',
        type: 'custom',
        data: {},
        customColumns: ['Pusat', 'Wilayah', 'Buku Diimbas Oleh BS', 'Rekod daripada BSTM', 'Drop Record', 'MISSING'],
        ulasan: {},
        numberingStyle: 'main'
      };
      months.forEach(m => {
        secC.data[m] = [
          { kategori: 'Item 1', values: [0, 0, 0, 0, 0, 0] }
        ];
        secC.ulasan[m] = '';
      });
      
      // Section C.1 - Custom Table (subsection)
      const secC1 = {
        id: 'sec_c1_' + (Date.now() + 3),
        title: 'Tajuk',
        type: 'custom',
        data: {},
        customColumns: ['Pusat', 'Wilayah', 'Buku Diimbas Oleh BS', 'Rekod daripada BSTM', 'Drop Record', 'MISSING'],
        ulasan: {},
        numberingStyle: 'sub'
      };
      months.forEach(m => {
        secC1.data[m] = [
          { kategori: 'Item 1', values: [0, 0, 0, 0, 0, 0] }
        ];
        secC1.ulasan[m] = '';
      });
      
      // Section C.2 - Custom Table (subsection, different columns)
      const secC2 = {
        id: 'sec_c2_' + (Date.now() + 4),
        title: 'Tajuk',
        type: 'custom',
        data: {},
        customColumns: ['Pusat', 'Wilayah', 'Buku Diimbas Oleh BS', 'BPK', 'Drop Record BS'],
        ulasan: {},
        numberingStyle: 'sub'
      };
      months.forEach(m => {
        secC2.data[m] = [
          { kategori: 'Category 1', values: [0, 0, 0, 0, 0] },
          { kategori: 'Category 2', values: [0, 0, 0, 0, 0] }
        ];
        secC2.ulasan[m] = '';
      });
      
      // Section D - Ulasan Only (HAL-HAL LAIN)
      const secD = {
        id: 'sec_d_' + (Date.now() + 5),
        title: 'HAL-HAL LAIN',
        type: 'ulasan-only',
        data: {},
        customColumns: [],
        ulasan: {},
        numberingStyle: 'main'
      };
      months.forEach(m => {
        secD.ulasan[m] = '';
      });
      
      sections = [secA, secB, secC, secC1, secC2, secD];
      
      // Save to persistent data
      sections.forEach(sec => {
        persistentData[sec.id] = JSON.parse(JSON.stringify(sec));
      });
      
      // Save to localStorage
      localStorage.setItem('phs_template_sections', JSON.stringify(sections));
      localStorage.setItem('phs_template_persistent', JSON.stringify(persistentData));
    }
    
    let settings = JSON.parse(localStorage.getItem('phs_template_settings')) || {
      department: 'BAHAGIAN SIRKULASI',
      orgName: 'PERPUSTAKAAN HAMZAH SENDUT',
      month: 'Januari',
      year: '2026'
    };

    let sections = JSON.parse(localStorage.getItem('phs_template_sections')) || [];
    let persistentData = JSON.parse(localStorage.getItem('phs_template_persistent')) || {};
    let archive = JSON.parse(localStorage.getItem('phs_template_archive')) || [];
    
    // Initialize with default sections if empty
    if(sections.length === 0) {
      initializeDefaultSections();
    }

    function init() {
      // Setup month selector
      const mS = document.getElementById('monthSelect');
      months.forEach(m => mS.options.add(new Option(m, m)));
      mS.value = settings.month;
      document.getElementById('yearSelect').value = settings.year;

      // Setup dashboard month selector
      const dmS = document.getElementById('dashboardMonthSelect');
      months.forEach(m => dmS.options.add(new Option(m, m)));
      dmS.value = settings.month;

      // Load settings
      document.getElementById('orgDepartment').value = settings.department;
      document.getElementById('orgName').value = settings.orgName;

      updateHeaderPreview();
      renderSectionsList();
      updateSidebar();
    }

    function renderDashboardUtama() {
      const selectedMonth = document.getElementById('dashboardMonthSelect').value;
      const mIdx = months.indexOf(selectedMonth);
      const prevMonth = mIdx > 0 ? months[mIdx - 1] : null;

      // Check if there's any data
      const hasData = sections.length > 0 && sections.some(sec => 
        sec.type === 'standard' && sec.data[selectedMonth] && sec.data[selectedMonth].length > 0
      );

      // Calculate KPIs
      let totalCurrent = 0;
      let totalPrev = 0;
      let monthlyTotals = months.map(() => 0);

      sections.forEach(sec => {
        if(sec.type === 'standard') {
          months.forEach((m, mi) => {
            if(sec.data[m]) {
              sec.data[m].forEach(row => {
                const val = row.val || 0;
                monthlyTotals[mi] += val;
                if(m === selectedMonth) totalCurrent += val;
                if(m === prevMonth) totalPrev += val;
              });
            }
          });
        }
      });

      // Calculate stats
      const cumulative = monthlyTotals.slice(0, mIdx + 1).reduce((a, b) => a + b, 0);
      const average = cumulative / (mIdx + 1);
      const maxValue = Math.max(...monthlyTotals.slice(0, mIdx + 1));
      const maxMonthIdx = monthlyTotals.indexOf(maxValue);

      // Update KPI cards
      const changePercent = totalPrev > 0 ? (((totalCurrent - totalPrev) / totalPrev) * 100).toFixed(1) : 0;
      const changeClass = changePercent >= 0 ? 'text-green-600' : 'text-red-600';
      const changeIcon = changePercent >= 0 ? '‚Üë' : '‚Üì';

      document.getElementById('kpi-total').textContent = totalCurrent.toLocaleString();
      document.getElementById('kpi-avg').textContent = average.toFixed(0);
      document.getElementById('kpi-max').textContent = maxValue.toLocaleString();
      document.getElementById('kpi-max-month').textContent = months[maxMonthIdx];
      document.getElementById('kpi-cumulative').textContent = cumulative.toLocaleString();

      document.getElementById('kpi-total-change').textContent = `${changeIcon} ${Math.abs(changePercent)}%`;
      document.getElementById('kpi-total-change').className = `font-bold ${changeClass}`;
      
      if(prevMonth) {
        document.getElementById('kpi-total-comparison').textContent = `Dari ${prevMonth.toLowerCase()}`;
      } else {
        document.getElementById('kpi-total-comparison').textContent = `Bulan pertama`;
      }

      // Render charts for each section
      const chartsContainer = document.getElementById('dashboardChartsGrid');
      chartsContainer.innerHTML = '';

      if(!hasData) {
        chartsContainer.innerHTML = `
          <div class="col-span-2 glass-panel p-12 text-center">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">insert_chart</span>
            <h3 class="heading-font text-2xl text-slate-600 mb-2">TIADA DATA</h3>
            <p class="text-slate-500 mb-6">Dashboard akan auto-update bila anda masukkan data dalam laporan.</p>
            <div class="space-y-2 text-sm text-slate-600">
              <p>üìù Pergi ke <strong>TETAPAN</strong> ‚Üí Tambah Seksyen</p>
              <p>üìä Pergi ke <strong>LAPORAN</strong> ‚Üí Masukkan Data</p>
              <p>üîÑ Dashboard akan refresh automatically</p>
            </div>
            <button onclick="setPage('settings')" class="mt-6 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-black hover:scale-105 transition">
              PERGI KE TETAPAN
            </button>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        if(sec.type === 'ulasan-only' || sec.type === 'jumlah') return;

        const card = document.createElement('div');
        card.className = 'glass-panel p-6 animate-in';
        card.style.animationDelay = `${idx * 0.1}s`;

        const chartId = `dash-chart-${sec.id}`;
        const sectionLabel = getSectionLabel(idx);
        
        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="heading-font text-lg text-slate-800">${sectionLabel}. ${sec.title}</h3>
              <p class="text-xs text-slate-500 mt-1">Trend Tahunan ${settings.year}</p>
            </div>
            <select onchange="changeDashChartType('${chartId}', this.value)" class="text-xs p-2 border-2 rounded-lg font-bold">
              <option value="line">Line</option>
              <option value="bar">Bar</option>
            </select>
          </div>
          <div class="h-64">
            <canvas id="${chartId}"></canvas>
          </div>
        `;

        chartsContainer.appendChild(card);

        setTimeout(() => {
          if(sec.type === 'standard') {
            renderDashboardChart(sec, chartId);
          } else if(sec.type === 'custom') {
            renderDashboardChartCustom(sec, chartId);
          }
        }, 100);
      });
    }

    function renderDashboardChart(sec, chartId) {
      const ctx = document.getElementById(chartId);
      if(!ctx) return;

      const datasets = sec.data["Januari"].map((row, idx) => {
        const colors = ['#0047FF', '#FF3366', '#00D9FF', '#00E676', '#FFD600', '#9C27B0', '#FF6B00', '#00BFA5'];
        return {
          label: row.kategori,
          data: months.map(m => getVal(sec.id, m, row.kategori)),
          borderColor: colors[idx % colors.length],
          backgroundColor: colors[idx % colors.length] + '20',
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: false
        };
      });

      window['chart_' + chartId] = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: months,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { weight: 'bold', size: 10 },
                padding: 10,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 }
            },
            datalabels: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { weight: 'bold' } }
            },
            x: {
              grid: { display: false },
              ticks: { font: { weight: 'bold', size: 10 } }
            }
          }
        }
      });
    }

    function renderDashboardChartCustom(sec, chartId) {
      const ctx = document.getElementById(chartId);
      if(!ctx) return;

      // For custom tables, show total per month
      const monthlyTotals = months.map(m => {
        if(!sec.data[m]) return 0;
        return sec.data[m].reduce((sum, row) => {
          return sum + (row.values || []).reduce((a, b) => a + (b || 0), 0);
        }, 0);
      });

      window['chart_' + chartId] = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Total',
            data: monthlyTotals,
            backgroundColor: '#9C27B0',
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              display: false
            }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function changeDashChartType(chartId, type) {
      const chart = window['chart_' + chartId];
      if(!chart) return;

      chart.config.type = type;
      chart.update();
    }

    function saveSettings() {
      settings.department = document.getElementById('orgDepartment').value;
      settings.orgName = document.getElementById('orgName').value;
      settings.month = document.getElementById('monthSelect').value;
      settings.year = document.getElementById('yearSelect').value;
      
      localStorage.setItem('phs_template_settings', JSON.stringify(settings));
      updateHeaderPreview();
      updateSidebar();
    }

    function autoSave() {
      localStorage.setItem('phs_template_sections', JSON.stringify(sections));
      localStorage.setItem('phs_template_persistent', JSON.stringify(persistentData));
      localStorage.setItem('phs_template_archive', JSON.stringify(archive));
      updateSidebar();
      
      // Auto-refresh dashboard if it's currently visible
      const dashboardPage = document.getElementById('dashboard-utamaPage');
      if(dashboardPage && !dashboardPage.classList.contains('hidden')) {
        renderDashboardUtama();
      }
    }

    function updateHeaderPreview() {
      const preview1 = document.getElementById('headerPreview1');
      const preview2 = document.getElementById('headerPreview2');
      const preview3 = document.getElementById('headerPreview3');
      
      if(preview1) preview1.textContent = settings.department;
      if(preview2) preview2.textContent = settings.orgName;
      if(preview3) preview3.textContent = `LAPORAN BULANAN ${settings.month.toUpperCase()} ${settings.year}`;

      // Update report headers
      const h1 = document.getElementById('reportHeader1');
      const h2 = document.getElementById('reportHeader2');
      const h3 = document.getElementById('reportHeader3');
      if(h1) h1.textContent = settings.department;
      if(h2) h2.textContent = settings.orgName;
      if(h3) h3.textContent = `LAPORAN BULANAN ${settings.month.toUpperCase()} ${settings.year}`;
    }

    function updateSidebar() {
      document.getElementById('sidebarSections').textContent = sections.length;
      document.getElementById('sidebarMonth').textContent = settings.month;
      document.getElementById('sidebarArchive').textContent = archive.length;
    }

    function addSection(type = 'standard', numberingStyle = 'auto') {
      const newSection = {
        id: 'sec_' + Date.now(),
        title: 'TAJUK SEKSYEN',
        type: type,
        data: {},
        customColumns: [],
        numberingStyle: numberingStyle // 'auto', 'main', 'sub'
      };

      if(type === 'standard') {
        months.forEach(m => {
          newSection.data[m] = [
            { kategori: 'Category 1', val: 0 },
            { kategori: 'Category 2', val: 0 }
          ];
        });
      } else if(type === 'custom') {
        newSection.customColumns = ['Pusat', 'Wilayah', 'Buku Diimbas Oleh BS', 'Rekod daripada BSTM', 'Drop Record', 'MISSING'];
        months.forEach(m => {
          newSection.data[m] = [
            { kategori: 'Item 1', values: Array(6).fill(0) }
          ];
        });
      } else if(type === 'jumlah') {
        newSection.data = {};
      }

      newSection.ulasan = {};
      months.forEach(m => newSection.ulasan[m] = '');

      sections.push(newSection);
      persistentData[newSection.id] = JSON.parse(JSON.stringify(newSection));
      
      renderSectionsList();
      autoSave();
    }

    function showAddSectionModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-4xl p-8">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Pilih Jenis Seksyen</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button onclick="selectSectionType('standard')" id="btn-standard"
                    class="p-6 border-3 border-blue-500 bg-blue-50 rounded-xl hover:border-blue-600 hover:bg-blue-100 transition text-center">
              <span class="material-symbols-outlined text-5xl text-blue-600 mb-3">table_chart</span>
              <div class="font-black text-lg mb-2">STANDARD</div>
              <div class="text-xs text-slate-600">Jadual + Graf + Ulasan</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen A, B)</div>
            </button>
            
            <button onclick="selectSectionType('custom')" id="btn-custom"
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-purple-600 mb-3">view_column</span>
              <div class="font-black text-lg mb-2">CUSTOM TABLE</div>
              <div class="text-xs text-slate-600">Kolum tersuai + Ulasan</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen C)</div>
              <div class="text-xs text-blue-600 mt-2 font-bold">+ JUMLAH auto-calc</div>
            </button>
            
            <button onclick="selectSectionType('ulasan-only')" id="btn-ulasan"
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-orange-600 mb-3">notes</span>
              <div class="font-black text-lg mb-2">ULASAN SAHAJA</div>
              <div class="text-xs text-slate-600">Tiada jadual/graf</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen D)</div>
            </button>
          </div>
          
          <div id="numberingOptions" class="mb-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
            <h4 class="font-bold text-slate-800 mb-3">Pilih Gaya Penomboran:</h4>
            <div class="flex gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="numbering" value="main" checked class="w-5 h-5">
                <span class="font-bold">Main Section (A, B, C, D...)</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="numbering" value="sub" class="w-5 h-5">
                <span class="font-bold">Subsection (C.1, C.2, C.3...)</span>
              </label>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="confirmAddSection()" 
                    class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">
              TAMBAH
            </button>
            <button onclick="this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">
              BATAL
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      window.selectedSectionType = 'standard';
    }
    
    function selectSectionType(type) {
      window.selectedSectionType = type;
      
      // Update button styles
      ['standard', 'custom', 'ulasan'].forEach(t => {
        const btn = document.getElementById('btn-' + t);
        if(btn) {
          if(t === type) {
            btn.className = btn.className.replace('border-slate-200', 'border-blue-500 bg-blue-50');
          } else {
            btn.className = btn.className.replace('border-blue-500 bg-blue-50', 'border-slate-200');
          }
        }
      });
    }
    
    function confirmAddSection() {
      const numberingStyle = document.querySelector('input[name="numbering"]:checked').value;
      addSection(window.selectedSectionType, numberingStyle);
      document.querySelector('.fixed').remove();
    }

    function renderSectionsList() {
      const container = document.getElementById('sectionsList');
      container.innerHTML = '';

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="text-center p-12 border-2 border-dashed border-slate-300 rounded-xl">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">inbox</span>
            <p class="text-slate-500 font-bold">Tiada seksyen. Klik "TAMBAH SEKSYEN" untuk mula.</p>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "border-2 border-slate-200 rounded-xl p-4 hover:border-blue-400 transition";
        
        const typeBadges = {
          'standard': '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">üìä STANDARD</span>',
          'custom': '<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">üîß CUSTOM</span>',
          'jumlah': '<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold">üßÆ JUMLAH</span>',
          'ulasan-only': '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">üí¨ ULASAN</span>'
        };
        
        const sectionLabel = getSectionLabel(idx);
        
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4 flex-1">
              <div class="text-2xl font-black text-blue-600">${sectionLabel}.</div>
              <input value="${sec.title}" 
                     oninput="sections[${idx}].title = this.value; persistentData['${sec.id}'].title = this.value; autoSave();"
                     class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold text-lg hover:border-blue-300 transition">
              ${typeBadges[sec.type || 'standard']}
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="moveSection(${idx}, -1)" class="p-2 hover:bg-blue-50 rounded-lg transition" ${idx === 0 ? 'disabled style="opacity:0.3"' : ''}>
                <span class="material-symbols-outlined text-blue-600">arrow_upward</span>
              </button>
              <button onclick="moveSection(${idx}, 1)" class="p-2 hover:bg-blue-50 rounded-lg transition" ${idx === sections.length-1 ? 'disabled style="opacity:0.3"' : ''}>
                <span class="material-symbols-outlined text-blue-600">arrow_downward</span>
              </button>
              ${sec.type === 'custom' ? `<button onclick="editCustomColumns(${idx})" class="p-2 hover:bg-purple-50 rounded-lg transition" title="Edit Columns">
                <span class="material-symbols-outlined text-purple-600">view_column</span>
              </button>` : ''}
              <button onclick="deleteSection(${idx})" class="p-2 hover:bg-red-50 rounded-lg transition">
                <span class="material-symbols-outlined text-red-600">delete</span>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function moveSection(idx, dir) {
      if (idx + dir < 0 || idx + dir >= sections.length) return;
      [sections[idx], sections[idx+dir]] = [sections[idx+dir], sections[idx]];
      renderSectionsList();
      autoSave();
    }

    function deleteSection(idx) {
      if(confirm(`Padam seksyen "${sections[idx].title}"?\n\nData akan dipadam dari laporan dan data tahunan.`)) {
        const secId = sections[idx].id;
        sections.splice(idx, 1);
        delete persistentData[secId];
        renderSectionsList();
        autoSave();
      }
    }

    function renderReport() {
      const container = document.getElementById('reportContent');
      container.innerHTML = '';
      updateHeaderPreview();

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="text-center p-12">
            <p class="text-slate-500 font-bold text-lg">Tiada seksyen untuk dipaparkan.</p>
            <p class="text-slate-400 text-sm mt-2">Pergi ke TETAPAN untuk tambah seksyen.</p>
          </div>
        `;
        return;
      }

      const m = settings.month;
      const mIdx = months.indexOf(m);

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "section-container animate-in";
        div.style.animationDelay = `${idx * 0.1}s`;

        let content = '';
        
        const sectionLabel = getSectionLabel(idx);

        // Header
        content += `
          <div class="flex justify-between items-start mb-4 no-print">
            <div class="section-label">${sectionLabel}. ${sec.title}</div>
          </div>
          <div class="print:block hidden mb-4">
            <div class="section-label">${sectionLabel}. ${sec.title}</div>
          </div>
        `;

        const secType = sec.type || 'standard';

        // STANDARD TYPE
        if(secType === 'standard') {
          let monthHeaders = '';
          let showMonths = [];
          
          // Show only previous month + current month
          if(mIdx === 0) {
            // January: show only JANUARI
            showMonths = ['Januari'];
            monthHeaders = '<th>JANUARI</th>';
          } else {
            // Other months: show previous month + current month
            showMonths = [months[mIdx - 1], months[mIdx]];
            monthHeaders = `<th>${months[mIdx - 1].toUpperCase()}</th><th>${months[mIdx].toUpperCase()}</th>`;
          }

          const rows = sec.data[m].map((row, ri) => {
            let monthlyCols = '';
            let cumulative = 0;
            
            // Calculate cumulative from start of year up to current month
            for(let i = 0; i <= mIdx; i++) {
              cumulative += getVal(sec.id, months[i], row.kategori);
            }
            
            // Show columns for display months only
            showMonths.forEach(month => {
              const val = getVal(sec.id, month, row.kategori);
              monthlyCols += `<td><input type="number" value="${val}" 
                oninput="updateVal('${sec.id}', ${ri}, '${month}', this.value)" 
                class="w-full text-center font-bold bg-transparent outline-none p-1"></td>`;
            });

            return `
              <tr>
                <td>
                  <input value="${row.kategori}" 
                         oninput="updateKategori('${sec.id}', ${ri}, this.value)"
                         class="w-full font-bold bg-transparent outline-none p-1">
                </td>
                ${monthlyCols}
                <td class="kumulatif-col">${cumulative}</td>
                <td class="no-print">
                  <button onclick="removeRow('${sec.id}', ${ri})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
                </td>
              </tr>
            `;
          }).join('');

          // Calculate JUMLAH row
          let jumlahRow = '<tr class="jumlah-row"><td class="font-black text-left">JUMLAH</td>';
          showMonths.forEach(month => {
            const monthTotal = sec.data[m].reduce((sum, row) => {
              return sum + getVal(sec.id, month, row.kategori);
            }, 0);
            jumlahRow += `<td class="jumlah-col">${monthTotal}</td>`;
          });
          
          // Kumulatif total (sum from start of year to current month)
          const kumulatifTotal = sec.data[m].reduce((sum, row) => {
            let rowCumulative = 0;
            for(let i = 0; i <= mIdx; i++) {
              rowCumulative += getVal(sec.id, months[i], row.kategori);
            }
            return sum + rowCumulative;
          }, 0);
          jumlahRow += `<td class="jumlah-col">${kumulatifTotal}</td><td class="no-print"></td></tr>`;

          content += `
            <table>
              <thead>
                <tr>
                  <th class="text-left">KATEGORI</th>
                  ${monthHeaders}
                  <th class="bg-orange-700">KUMULATIF</th>
                  <th class="no-print w-10"></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${jumlahRow}
              </tbody>
            </table>

            <button onclick="addRow('${sec.id}')" class="no-print mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">
              + TAMBAH BARIS
            </button>

            <div class="mt-6">
              <div class="chart-container bg-slate-50 p-4 rounded-xl border-2 mb-4" style="height: 300px;">
                <canvas id="chart-${sec.id}"></canvas>
              </div>
              <div class="ulasan">
                <div class="ulasan-title">ULASAN</div>
                <textarea 
                  oninput="updateUlasan('${sec.id}', this.value)" 
                  class="w-full h-40 p-4 border-2 border-slate-200 rounded-xl resize-none"
                  placeholder="Tulis ulasan di sini...">${sec.ulasan[m] || ''}</textarea>
                <div class="hidden print:block print-ulasan-content">${sec.ulasan[m] || ''}</div>
              </div>
            </div>
          `;
        }

        // CUSTOM TABLE TYPE
        else if(secType === 'custom') {
          const customCols = sec.customColumns || [];
          const colHeaders = customCols.map(col => `<th>${col}</th>`).join('');

          const rows = sec.data[m].map((row, ri) => {
            const vals = row.values || [];
            const cells = vals.map((v, ci) => `
              <td><input type="number" value="${v}" 
                    oninput="updateCustomVal('${sec.id}', ${ri}, ${ci}, this.value)"
                    class="w-full text-center font-bold bg-transparent outline-none p-1"></td>
            `).join('');
            
            const jumlah = vals.reduce((a, b) => a + (b || 0), 0);

            return `
              <tr>
                <td>
                  <input value="${row.kategori}" 
                         oninput="updateKategori('${sec.id}', ${ri}, this.value)"
                         class="w-full font-bold bg-transparent outline-none p-1">
                </td>
                ${cells}
                <td class="jumlah-col">${jumlah}</td>
                <td class="no-print">
                  <button onclick="removeRow('${sec.id}', ${ri})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
                </td>
              </tr>
            `;
          }).join('');

          // JUMLAH row for custom
          const totals = customCols.map((col, ci) => {
            return sec.data[m].reduce((sum, row) => sum + ((row.values || [])[ci] || 0), 0);
          });
          const grandTotal = totals.reduce((a, b) => a + b, 0);
          
          let jumlahRow = '<tr class="jumlah-row"><td class="font-black text-left">JUMLAH</td>';
          totals.forEach(t => {
            jumlahRow += `<td class="jumlah-col">${t}</td>`;
          });
          jumlahRow += `<td class="jumlah-col">${grandTotal}</td><td class="no-print"></td></tr>`;

          content += `
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th class="text-left">KATEGORI</th>
                    ${colHeaders}
                    <th class="bg-orange-700">JUMLAH</th>
                    <th class="no-print w-10"></th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                  ${jumlahRow}
                </tbody>
              </table>
            </div>

            <div class="no-print flex gap-2 mt-2">
              <button onclick="addRowCustom('${sec.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">
                + TAMBAH BARIS
              </button>
              <button onclick="editCustomColumns(${idx})" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-bold text-sm hover:bg-purple-700">
                <span class="material-symbols-outlined text-sm">edit</span> EDIT KOLUM
              </button>
            </div>

            <div class="mt-6">
              <div class="ulasan">
                <div class="ulasan-title">ULASAN</div>
                <textarea 
                  oninput="updateUlasan('${sec.id}', this.value)" 
                  class="w-full h-40 p-4 border-2 border-slate-200 rounded-xl resize-none"
                  placeholder="Tulis ulasan di sini...">${sec.ulasan[m] || ''}</textarea>
                <div class="hidden print:block print-ulasan-content">${sec.ulasan[m] || ''}</div>
              </div>
            </div>
          `;
        }

        // ULASAN ONLY TYPE
        else if(secType === 'ulasan-only') {
          content += `
            <div class="mt-4">
              <div class="ulasan">
                <div class="ulasan-title">ULASAN</div>
                <textarea 
                  oninput="updateUlasan('${sec.id}', this.value)" 
                  class="w-full h-64 p-4 border-2 border-slate-200 rounded-xl resize-none"
                  placeholder="Tulis ulasan dan maklumat tambahan di sini...">${sec.ulasan[m] || ''}</textarea>
                <div class="hidden print:block print-ulasan-content">${sec.ulasan[m] || ''}</div>
              </div>
            </div>
          `;
        }

        // JUMLAH TYPE
        else if(secType === 'jumlah') {
          let grandTotals = {};
          months.forEach(month => grandTotals[month] = 0);

          sections.forEach(s => {
            if(s.type === 'standard' && s.data[m]) {
              s.data[m].forEach(row => {
                months.forEach(month => {
                  grandTotals[month] += getVal(s.id, month, row.kategori);
                });
              });
            }
          });

          let jumlahHeaders = '';
          let jumlahCells = '';
          let kumulatifTotal = 0;

          // Show only previous month + current month
          if(mIdx === 0) {
            // January: show only JANUARI
            jumlahHeaders = '<th>JANUARI</th>';
            jumlahCells = `<td class="text-center font-black text-lg">${grandTotals['Januari']}</td>`;
            kumulatifTotal = grandTotals['Januari'];
          } else {
            // Other months: show previous + current
            jumlahHeaders = `<th>${months[mIdx - 1].toUpperCase()}</th><th>${months[mIdx].toUpperCase()}</th>`;
            jumlahCells = `<td class="text-center font-black text-lg">${grandTotals[months[mIdx - 1]]}</td>`;
            jumlahCells += `<td class="text-center font-black text-lg">${grandTotals[months[mIdx]]}</td>`;
            
            // Kumulatif is sum from start of year to current month
            for(let i = 0; i <= mIdx; i++) {
              kumulatifTotal += grandTotals[months[i]];
            }
          }

          content += `
            <table>
              <thead>
                <tr>
                  <th class="text-left">BULAN</th>
                  ${jumlahHeaders}
                  <th class="bg-orange-700">KUMULATIF</th>
                </tr>
              </thead>
              <tbody>
                <tr class="jumlah-row">
                  <td class="font-black text-left">JUMLAH KESELURUHAN</td>
                  ${jumlahCells}
                  <td class="kumulatif-col text-center font-black text-lg">${kumulatifTotal}</td>
                </tr>
              </tbody>
            </table>
            <div class="mt-4 p-4 bg-blue-50 rounded-xl border-2 border-blue-200">
              <p class="text-xs text-blue-800"><strong>Nota:</strong> Jadual ini auto-calculate jumlah daripada semua seksyen standard.</p>
            </div>
          `;
        }

        div.innerHTML = content;
        container.appendChild(div);
        
        if(secType === 'standard') {
          setTimeout(() => renderChart(sec), 100);
        }
      });
    }

    function getVal(secId, month, kategori) {
      const sec = persistentData[secId];
      if(!sec || !sec.data[month]) return 0;
      const row = sec.data[month].find(r => r.kategori === kategori);
      return row ? (row.val || 0) : 0;
    }

    function updateVal(secId, rowIdx, month, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec && sec.data[month][rowIdx]) {
        sec.data[month][rowIdx].val = Number(val);
        persistentData[secId].data[month][rowIdx].val = Number(val);
        autoSave();
        renderReport();
      }
    }

    function updateKategori(secId, rowIdx, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        months.forEach(m => {
          if(sec.data[m] && sec.data[m][rowIdx]) {
            sec.data[m][rowIdx].kategori = val;
            persistentData[secId].data[m][rowIdx].kategori = val;
          }
        });
        autoSave();
      }
    }

    function updateUlasan(secId, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        sec.ulasan[settings.month] = val;
        persistentData[secId].ulasan[settings.month] = val;
        autoSave();
      }
    }

    function updateCustomVal(secId, rowIdx, colIdx, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec && sec.data[settings.month][rowIdx]) {
        sec.data[settings.month][rowIdx].values[colIdx] = Number(val);
        persistentData[secId].data[settings.month][rowIdx].values[colIdx] = Number(val);
        autoSave();
        renderReport();
      }
    }

    function addRowCustom(secId) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        const numCols = sec.customColumns.length;
        const newRow = { kategori: 'Item Baru', values: Array(numCols).fill(0) };
        months.forEach(m => {
          if(!sec.data[m]) sec.data[m] = [];
          sec.data[m].push(JSON.parse(JSON.stringify(newRow)));
          if(!persistentData[secId].data[m]) persistentData[secId].data[m] = [];
          persistentData[secId].data[m].push(JSON.parse(JSON.stringify(newRow)));
        });
        autoSave();
        renderReport();
      }
    }

    function editCustomColumns(idx) {
      const sec = sections[idx];
      const currentCols = sec.customColumns || [];
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-2xl p-8">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Edit Kolum Custom</h3>
          
          <div id="columnsList" class="space-y-2 mb-4"></div>
          
          <button onclick="addCustomColumn()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 mb-4">
            + TAMBAH KOLUM
          </button>

          <div class="flex gap-3">
            <button onclick="saveCustomColumns(${idx}); this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">
              SIMPAN
            </button>
            <button onclick="this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">
              BATAL
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      window.tempColumns = [...currentCols];
      renderColumnsList();
    }

    function renderColumnsList() {
      const container = document.getElementById('columnsList');
      if(!container) return;
      
      container.innerHTML = window.tempColumns.map((col, idx) => `
        <div class="flex items-center gap-2">
          <input value="${col}" 
                 oninput="window.tempColumns[${idx}] = this.value"
                 class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold"
                 placeholder="Nama Kolum ${idx + 1}">
          <button onclick="window.tempColumns.splice(${idx}, 1); renderColumnsList();" 
                  class="p-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      `).join('');
    }

    function addCustomColumn() {
      window.tempColumns.push('Kolum Baru');
      renderColumnsList();
    }

    function saveCustomColumns(idx) {
      const sec = sections[idx];
      sec.customColumns = [...window.tempColumns];
      persistentData[sec.id].customColumns = [...window.tempColumns];
      
      months.forEach(m => {
        if(!sec.data[m]) sec.data[m] = [];
        sec.data[m].forEach(row => {
          const oldLen = (row.values || []).length;
          const newLen = sec.customColumns.length;
          if(newLen > oldLen) {
            if(!row.values) row.values = [];
            row.values.push(...Array(newLen - oldLen).fill(0));
          } else if(newLen < oldLen) {
            row.values = row.values.slice(0, newLen);
          }
        });
        persistentData[sec.id].data[m] = JSON.parse(JSON.stringify(sec.data[m]));
      });
      
      autoSave();
      renderSectionsList();
      renderReport();
    }

    function addRow(secId) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        months.forEach(m => {
          if(!sec.data[m]) sec.data[m] = [];
          sec.data[m].push({ kategori: 'Kategori Baru', val: 0 });
          if(!persistentData[secId].data[m]) persistentData[secId].data[m] = [];
          persistentData[secId].data[m].push({ kategori: 'Kategori Baru', val: 0 });
        });
        autoSave();
        renderReport();
      }
    }

    function removeRow(secId, rowIdx) {
      if(confirm('Padam baris ini?')) {
        const sec = sections.find(s => s.id === secId);
        if(sec) {
          months.forEach(m => {
            if(sec.data[m]) sec.data[m].splice(rowIdx, 1);
            if(persistentData[secId].data[m]) persistentData[secId].data[m].splice(rowIdx, 1);
          });
          autoSave();
          renderReport();
        }
      }
    }

    function renderChart(sec) {
      const ctx = document.getElementById(`chart-${sec.id}`);
      if(!ctx) return;
      
      const m = settings.month;
      const data = sec.data[m] || [];
      
      new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: data.map(r => r.kategori),
          datasets: [{
            label: sec.title,
            data: data.map(r => r.val || 0),
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: sec.title,
              font: {
                size: 14,
                weight: 'bold'
              },
              padding: {
                top: 10,
                bottom: 20
              }
            },
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'end',
              offset: 4,
              font: { 
                weight: 'bold', 
                size: 12 
              },
              color: '#1d4ed8',
              formatter: (val) => val > 0 ? val : ''
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { weight: 'bold' } }
            },
            x: { 
              grid: { display: false },
              ticks: { font: { weight: 'bold' } }
            }
          }
        }
      });
    }

    function renderSummary() {
      const container = document.getElementById('summaryContent');
      container.innerHTML = '';

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="glass-panel p-12 text-center">
            <p class="text-slate-500 font-bold">Tiada data untuk dipaparkan.</p>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "glass-panel p-8 animate-in";
        div.style.animationDelay = `${idx * 0.1}s`;
        
        const sectionLabel = getSectionLabel(idx);

        if(sec.type === 'ulasan-only') {
          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-4">${sectionLabel}. ${sec.title}</h3>
            <p class="text-slate-500 italic">Seksyen ini hanya mengandungi ulasan, tiada data jadual.</p>
          `;
          container.appendChild(div);
          return;
        }

        if(sec.type === 'custom') {
          const customCols = sec.customColumns || [];
          const firstMonth = sec.data["Januari"] || [];
          
          const rows = firstMonth.map((r, ri) => {
            const kategori = r.kategori;
            
            let rowHtml = `<tr class="hover:bg-slate-50"><td class="text-left font-bold">${kategori}</td>`;
            
            months.forEach(m => {
              const mData = sec.data[m]?.find(row => row.kategori === kategori);
              const vals = mData ? mData.values : Array(customCols.length).fill(0);
              vals.forEach(v => {
                rowHtml += `<td>${v}</td>`;
              });
            });
            
            rowHtml += '</tr>';
            return rowHtml;
          }).join('');

          let headerRow = '<tr><th class="text-left">KATEGORI</th>';
          months.forEach(m => {
            customCols.forEach(col => {
              headerRow += `<th>${col}<br><span class="text-[8px]">${m.substring(0,3)}</span></th>`;
            });
          });
          headerRow += '</tr>';

          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-6">${sectionLabel}. ${sec.title} <span class="text-sm text-purple-600">(CUSTOM TABLE)</span></h3>
            <div class="overflow-x-auto">
              <table>
                <thead>${headerRow}</thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
          container.appendChild(div);
          return;
        }

        if(sec.type === 'jumlah') {
          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-4">${sectionLabel}. ${sec.title}</h3>
            <p class="text-slate-500 italic">Seksyen JUMLAH - auto-calculate dari seksyen standard.</p>
          `;
          container.appendChild(div);
          return;
        }

        // Standard table summary
        const firstMonth = sec.data["Januari"] || [];
        const rows = firstMonth.map((r, ri) => {
          const mVals = months.map(m => getVal(sec.id, m, r.kategori));
          const total = mVals.reduce((a,b) => a+b, 0);
          const avg = (total / 12).toFixed(1);

          return `
            <tr class="hover:bg-slate-50">
              <td class="text-left font-bold">${r.kategori}</td>
              ${mVals.map((v, i) => {
                const prev = i > 0 ? mVals[i-1] : v;
                const color = v > prev ? 'bg-green-50 text-green-700' : v < prev ? 'bg-red-50 text-red-700' : '';
                return `<td class="${color}">${v}</td>`;
              }).join('')}
              <td class="font-bold bg-yellow-50">${total}</td>
              <td class="font-bold bg-blue-50 text-blue-700">${avg}</td>
            </tr>
          `;
        }).join('');

        // JUMLAH row
        let jumlahRow = '<tr class="jumlah-row"><td class="text-left">JUMLAH</td>';
        let grandTotal = 0;
        months.forEach(m => {
          const monthTotal = firstMonth.reduce((sum, r) => {
            return sum + getVal(sec.id, m, r.kategori);
          }, 0);
          grandTotal += monthTotal;
          jumlahRow += `<td>${monthTotal}</td>`;
        });
        const avgTotal = (grandTotal / 12).toFixed(1);
        jumlahRow += `<td>${grandTotal}</td><td>${avgTotal}</td></tr>`;

        div.innerHTML = `
          <h3 class="heading-font text-2xl text-slate-800 mb-6">${sectionLabel}. ${sec.title}</h3>
          <div class="overflow-x-auto">
            <table>
              <thead>
                <tr>
                  <th class="text-left">KATEGORI</th>
                  ${months.map(m => `<th>${m.substring(0,3).toUpperCase()}</th>`).join('')}
                  <th class="bg-yellow-700">JUMLAH</th>
                  <th class="bg-blue-800">PURATA</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${jumlahRow}
              </tbody>
            </table>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function saveToArchive() {
      archive.push({
        id: Date.now(),
        month: settings.month,
        year: settings.year,
        department: settings.department,
        orgName: settings.orgName,
        sections: JSON.parse(JSON.stringify(sections)),
        timestamp: new Date().toLocaleString('ms-MY')
      });
      autoSave();
      alert('‚úÖ Laporan berjaya disimpan ke arkib!');
    }

    function renderArchive() {
      const container = document.getElementById('archiveList');
      container.innerHTML = '';

      if(archive.length === 0) {
        container.innerHTML = `
          <div class="glass-panel p-12 text-center">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">archive</span>
            <p class="text-slate-500 font-bold">Tiada arkib.</p>
          </div>
        `;
        return;
      }

      archive.slice().reverse().forEach((item, idx) => {
        const realIdx = archive.length - 1 - idx;
        const div = document.createElement('div');
        div.className = "glass-panel p-6 flex justify-between items-center animate-in";
        div.style.animationDelay = `${idx * 0.05}s`;

        div.innerHTML = `
          <div>
            <h3 class="heading-font text-lg text-slate-800">${item.department}</h3>
            <p class="text-sm text-slate-600">${item.orgName}</p>
            <p class="text-sm text-blue-600 font-bold mt-1">üìÖ ${item.month} ${item.year}</p>
            <p class="text-xs text-slate-400 mt-1">üíæ ${item.timestamp}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="loadArchive(${realIdx})" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              MUAT
            </button>
            <button onclick="deleteArchive(${realIdx})" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600">
              PADAM
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function loadArchive(idx) {
      if(confirm('Muat arkib ini? Data semasa akan diganti.')) {
        const item = archive[idx];
        settings.department = item.department;
        settings.orgName = item.orgName;
        settings.month = item.month;
        settings.year = item.year;
        sections = JSON.parse(JSON.stringify(item.sections));
        
        // Rebuild persistentData
        persistentData = {};
        sections.forEach(sec => {
          persistentData[sec.id] = JSON.parse(JSON.stringify(sec));
        });
        
        document.getElementById('orgDepartment').value = settings.department;
        document.getElementById('orgName').value = settings.orgName;
        document.getElementById('monthSelect').value = settings.month;
        document.getElementById('yearSelect').value = settings.year;
        
        saveSettings();
        renderSectionsList();
        setPage('settings');
        alert('‚úÖ Arkib berjaya dimuat!');
      }
    }

    function deleteArchive(idx) {
      if(confirm('Padam arkib ini?')) {
        archive.splice(idx, 1);
        autoSave();
        renderArchive();
      }
    }

    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      
      sections.forEach((sec, idx) => {
        if(sec.type === 'ulasan-only' || sec.type === 'jumlah') return;
        
        const data = [
          [`${sectionLabels[idx]}. ${sec.title}`],
          []
        ];
        
        if(sec.type === 'standard') {
          data.push(['Kategori', ...months, 'JUMLAH']);
          
          const firstMonth = sec.data["Januari"] || [];
          firstMonth.forEach(r => {
            const row = [r.kategori];
            const mVals = months.map(m => getVal(sec.id, m, r.kategori));
            const total = mVals.reduce((a,b) => a+b, 0);
            row.push(...mVals, total);
            data.push(row);
          });
        } else if(sec.type === 'custom') {
          const headers = ['Kategori'];
          sec.customColumns.forEach(col => {
            months.forEach(m => {
              headers.push(`${col} (${m.substring(0,3)})`);
            });
          });
          data.push(headers);
          
          const firstMonth = sec.data["Januari"] || [];
          firstMonth.forEach(r => {
            const row = [r.kategori];
            months.forEach(m => {
              const mData = sec.data[m]?.find(item => item.kategori === r.kategori);
              const vals = mData ? mData.values : [];
              row.push(...vals);
            });
            data.push(row);
          });
        }
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, sec.title.substring(0, 31));
      });
      
      XLSX.writeFile(wb, `Laporan_${settings.month}_${settings.year}.xlsx`);
      alert('‚úÖ Excel berjaya di-export!');
    }

    function setPage(page) {
      document.querySelectorAll('main > div[id$="Page"]').forEach(d => d.classList.add('hidden'));
      document.getElementById(page + 'Page').classList.remove('hidden');
      
      document.querySelectorAll('nav button').forEach(b => {
        b.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-500', 'from-blue-600', 'to-cyan-500', 'font-black');
        b.classList.add('hover:bg-slate-700/50', 'font-bold');
      });
      
      const btn = document.getElementById('nav-' + page);
      btn.classList.remove('hover:bg-slate-700/50', 'font-bold');
      
      if(page === 'settings') {
        btn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-500', 'font-black');
      } else {
        btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-cyan-500', 'font-black');
      }
      
      if(page === 'dashboard-utama') renderDashboardUtama();
      if(page === 'report') renderReport();
      if(page === 'summary') renderSummary();
      if(page === 'archive') renderArchive();
    }

    init();
  </script>
</body>
</html>
