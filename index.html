<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashBoard Bahagian - Sistem Laporan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e3a8a;
      --secondary: #1e40af;
      --accent: #3b82f6;
    }
    
    body { 
      font-family: 'Calibri', Arial, sans-serif; 
      font-size: 11pt; 
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      background-attachment: fixed;
    }
    
    .heading-font { 
      font-family: 'Calibri', Arial, sans-serif; 
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .glass-panel {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 1.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .report-header {
      text-align: left;
      margin-bottom: 2rem;
      padding: 1rem 0;
      position: relative;
      z-index: 10;
    }

    .report-header h1, .report-header h2, .report-header h3 {
      font-size: 12pt;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 0;
      line-height: 1.5;
      color: #000000;
    }
    
    .section-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }

    .section-label {
      display: inline-block;
      background: #1e3a8a;
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
      table-layout: auto;
    }

    th, td {
      padding: 0.5rem;
      border: 1px solid #cbd5e1;
      text-align: center;
      font-size: 0.9rem;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      vertical-align: middle;
    }

    th {
      background: #1e3a8a;
      color: white;
      border: 1px solid #1e40af;
    }

    td:first-child {
      text-align: left;
      font-weight: 600;
      max-width: 250px;
    }

    .kumulatif-col { background: #fef3c7 !important; color: #92400e; font-weight: 700; }
    .jumlah-col { background: #dbeafe !important; color: #1e40af; font-weight: 700; }
    .jumlah-row { background: #dbeafe; border-top: 2px solid #1e40af !important; }
    .jumlah-row td { font-weight: 700; color: #1e40af; border-top: 2px solid #1e40af; }

    /* HANYA UBAH DI SINI UNTUK PRINT */
    @media print {

/* ===============================
   FINAL FIX: GRAF PRINT BERTINDIH
   =============================== */

canvas {
  height: 220px !important;
  max-height: 220px !important;
  width: 100% !important;
  page-break-inside: avoid !important;
  display: block !important;
}

div:has(> canvas) {
  height: 240px !important;
  max-height: 240px !important;
  overflow: hidden !important;
  page-break-inside: avoid !important;
}

canvas,
.chartjs-render-monitor {
  transform: none !important;
}


      @page { 
        size: A4 portrait; 
        margin: 0.5cm 1.5cm; /* Kurangkan margin atas untuk header duduk lebih atas */
      }
      
      body { 
        background: white !important; 
        margin: 0 !important; 
        padding: 0 !important; 
      }
      .no-print { display: none !important; }
      main { 
        width: 100% !important; 
        padding: 0 !important; 
        margin: 0 !important; 
      }
      .report-page { 
        box-shadow: none !important; 
        padding: 0 !important;
        background: white !important;
        border-radius: 0 !important;
        margin-top: 0 !important;
      }
      
      /* FIX HEADER POSITION - Kekal atas */
      .report-header {
        position: relative !important;
        top: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 1rem !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        text-align: center !important;
        width: 100% !important;
        page-break-after: avoid !important;
      }
      
      .report-header h1, 
      .report-header h2, 
      .report-header h3 {
        line-height: 1.2 !important;
        margin: 0 !important;
        padding: 0 !important;
        font-size: 11pt !important;
        text-transform: uppercase !important;
        color: #000000 !important;
      }
      
      .report-header h1 {
        margin-bottom: 3px !important;
        font-weight: 800 !important;
      }
      
      .report-header h2 {
        margin-bottom: 3px !important;
        font-weight: 700 !important;
      }
      
      .report-header h3 {
        color: #000000 !important;
        font-weight: bold !important;
        margin-top: 5px !important;
        border-top: 2px solid #000000 !important;
        padding-top: 5px !important;
        display: inline-block !important;
      }
      
      .section-container {
        background: white !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
        margin-bottom: 10px !important;
        page-break-before: always !important;
        page-break-inside: avoid !important;
      }
      
      .section-container:first-child {
        page-break-before: auto !important;
        margin-top: 0 !important;
      }
      
      .section-label {
        background: transparent !important;
        color: black !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        margin-bottom: 5px !important;
        font-weight: bold !important;
        font-size: 10pt !important;
      }
      
      /* Force table to wrap text properly */
      table { 
        table-layout: fixed !important; 
        width: 100% !important;
        border-collapse: collapse !important;
        margin: 0.5rem 0 !important;
      }
      
      th, td { 
        word-wrap: break-word !important; 
        overflow-wrap: break-word !important; 
        white-space: normal !important; 
        font-size: 8pt !important;
        padding: 3px !important;
        line-height: 1.3 !important;
        border: 1px solid #000000 !important;
        text-align: left !important;
      }
      
      th {
        background: white !important;
        color: black !important;
        font-weight: bold !important;
        text-align: center !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        border: 1px solid #000000 !important;
      }
      
      /* First column left align with more width */
      td:first-child, th:first-child {
        width: 30% !important;
        word-break: break-word !important;
        text-align: left !important;
      }
      
      /* Number columns center align */
      td:not(:first-child) {
        text-align: center !important;
      }
      
      /* Jumlah row */
      .jumlah-row {
        background: white !important;
        border-top: 2px solid #000000 !important;
      }
      
      .jumlah-row td {
        font-weight: bold !important;
        border: 1px solid #000000 !important;
      }
      
      /* CRITICAL: Hide input fields and show text only */
      td input {
        font-size: 0 !important;
        color: transparent !important;
        border: none !important;
        background: transparent !important;
        width: 100% !important;
      }
      
      /* For contenteditable cells */
      td[contenteditable] {
        word-wrap: break-word !important;
        word-break: break-word !important;
        white-space: normal !important;
      }
      
      /* GRAF - COMPACT print size, NO whitespace */
      canvas { 
        max-height: 180px !important;
        height: 180px !important;
        width: 100% !important;
        page-break-inside: avoid !important;
        display: block !important;
        margin: 0 auto !important;
        padding: 0 !important;
      }
      
      /* Chart container - TIGHT fit */
      div:has(> canvas) {
        max-height: 200px !important;
        height: 200px !important;
        page-break-inside: avoid !important;
        padding: 0 !important;
        margin: 0.5rem 0 !important;
        overflow: hidden !important;
      }
      
      /* HIDE ULASAN LABEL ONLY - KEEP CONTENT */
      textarea { display: none !important; }
      
      /* Show ulasan content */
      .ulasan-print { 
        display: block !important;
        white-space: pre-wrap;
        margin-top: 10px;
        line-height: 1.5;
        font-size: 9pt !important;
      }
      
      /* Hide ONLY the "ULASAN:" label */
      .ulasan-print-label { 
        display: none !important; 
      }
      
      /* Hide label that says "ULASAN" */
      label.block.text-sm.font-bold.text-slate-700.mb-2 {
        display: none !important;
      }
      
      /* Print text replacement for inputs */
      .print-text-replacement {
        word-wrap: break-word !important;
        white-space: normal !important;
        text-align: left !important;
        font-weight: 600 !important;
        font-size: 8pt !important;
        line-height: 1.3 !important;
      }
    }

    input:focus, textarea:focus, select:focus { 
      background-color: #f0f7ff !important; 
      outline: 3px solid var(--primary);
    }

    .animate-in { animation: slideInUp 0.6s ease forwards; }
    
    @keyframes slideInUp { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }

    .ulasan-print, .ulasan-print-label { display: none; }
  </style>
</head>
<body>

  <!-- Login Page -->
  <div id="loginPage" class="fixed inset-0 z-50 bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900 flex items-center justify-center p-4">
    <div class="glass-panel w-full max-w-md p-8">
      <div class="text-center mb-8">
        <h1 class="heading-font text-3xl text-slate-800 mb-2">üîê LOGIN</h1>
        <p class="text-slate-600 text-sm">Sistem Laporan Bulanan</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-2">USERNAME</label>
          <input type="text" id="loginUsername" class="w-full p-3 border-2 border-slate-200 rounded-lg font-bold" placeholder="Masukkan username">
        </div>
        
        <div>
          <label class="block text-sm font-bold text-slate-700 mb-2">PASSWORD</label>
          <input type="password" id="loginPassword" class="w-full p-3 border-2 border-slate-200 rounded-lg font-bold" placeholder="Masukkan password">
        </div>
        
        <button onclick="attemptLogin()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-black hover:scale-105 transition">
          MASUK
        </button>
        
        <button onclick="skipLoginAsViewer()" class="w-full py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold transition">
          üëÅÔ∏è VIEW ONLY
        </button>
        
        <div id="loginError" class="hidden p-3 bg-red-100 border-2 border-red-300 rounded-lg text-red-700 text-sm font-bold text-center">
        </div>
      </div>
    </div>
  </div>

  <div id="app" class="flex min-h-screen hidden">
    <!-- Sidebar -->
    <aside class="w-72 bg-gradient-to-b from-slate-800 via-slate-900 to-slate-950 text-white flex-shrink-0 no-print border-r border-slate-700 shadow-2xl">
      <div class="p-8">
        <div class="mb-12">
          <h2 class="heading-font text-3xl mb-1 text-white">DashBoard</h2>
          <h3 class="heading-font text-2xl text-blue-300">Bahagian</h3>
          <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mt-2">Sistem Laporan Bulanan</p>
        </div>
        
        <nav class="space-y-2">
          <button onclick="setPage('dashboard-utama')" id="nav-dashboard-utama" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">monitoring</span> DASHBOARD UTAMA
          </button>
          <button onclick="setPage('settings')" id="nav-settings" class="w-full text-left p-4 rounded-xl flex items-center gap-3 bg-gradient-to-r from-blue-600 to-blue-700 font-black text-sm">
            <span class="material-symbols-outlined">settings</span> TETAPAN
          </button>
          <button onclick="setPage('report')" id="nav-report" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">description</span> LAPORAN
          </button>
          <button onclick="setPage('summary')" id="nav-summary" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">table_chart</span> DATA TAHUNAN
          </button>
          <button onclick="setPage('archive')" id="nav-archive" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">archive</span> ARKIB
          </button>
          <button onclick="setPage('users')" id="nav-users" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            ‚öôÔ∏è PENGURUSAN PENGGUNA
          </button>
        </nav>

        <div class="mt-12 p-6 bg-slate-800/50 rounded-xl border border-slate-700">
          <h4 class="text-xs font-black uppercase text-slate-400 mb-3">Info Sistem</h4>
          <div class="space-y-2 text-xs text-slate-300">
            <div>üë§ User: <span id="sidebarUser" class="font-bold text-white">-</span></div>
            <div>üîë Role: <span id="sidebarRole" class="font-bold text-cyan-400">-</span></div>
            <div>üìä Seksyen: <span id="sidebarSections" class="font-bold text-white">0</span></div>
            <div>üìÖ Bulan: <span id="sidebarMonth" class="font-bold text-cyan-400">-</span></div>
            <div>üíæ Arkib: <span id="sidebarArchive" class="font-bold text-white">0</span></div>
          </div>
          <button onclick="logout()" class="mt-4 w-full py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold text-xs">
            üö™ LOG KELUAR
          </button>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
      
      <!-- Dashboard Utama Page -->
      <div id="dashboard-utamaPage" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">üìä Dashboard Utama</h2>
          <select id="dashboardYearSelect" onchange="renderDashboardUtama()" class="p-3 rounded-xl font-bold bg-white border-2 border-white">
          </select>
        </div>

        <!-- Dashboard KPI Section -->
        <div class="mb-8">
          <h3 class="heading-font text-2xl text-white mb-4">üìà KPI Seksyen</h3>
          <div id="dashboardKPIGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>

        <!-- Dashboard Graf Section -->
        <div>
          <h3 class="heading-font text-2xl text-white mb-4">üìä Graf Trend Tahunan</h3>
          <div id="dashboardChartsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settingsPage" class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">‚öôÔ∏è TETAPAN ORGANISASI</h2>
          <button onclick="logout()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">
            üö™ LOG KELUAR
          </button>
        </div>
        
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Maklumat Header Laporan</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Bahagian / Unit</label>
              <input type="text" id="orgDepartment" value="BAHAGIAN SIRKULASI" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Nama Organisasi</label>
              <input type="text" id="orgName" value="PERPUSTAKAAN HAMZAH SENDUT" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Bulan</label>
                <select id="monthSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()"></select>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Tahun</label>
                <select id="yearSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()">
                  <option>2026</option><option>2025</option><option>2024</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
            <div class="flex items-start gap-3">
              <span class="material-symbols-outlined text-blue-600">info</span>
              <div class="text-sm text-blue-800">
                <strong>Preview Header:</strong>
                <div class="mt-2 p-3 bg-white rounded border font-bold text-center">
                  <div id="headerPreview1">BAHAGIAN SIRKULASI</div>
                  <div id="headerPreview2">PERPUSTAKAAN HAMZAH SENDUT</div>
                  <div id="headerPreview3" class="text-blue-600">LAPORAN BULANAN JANUARI 2026</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass-panel p-8">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üì§ Upload Excel & Auto Generate</h3>
          <p class="text-slate-600 mb-4 text-sm">Upload fail Excel untuk auto-generate data. Format: Kolum pertama = Kategori, kolum seterusnya = Bulan (Januari-Disember)</p>
          
          <div class="flex gap-4 items-center mb-4">
            <input type="number" id="excelYear" placeholder="Tahun (e.g. 2026)" value="2026" class="w-32 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <input type="file" id="excelUpload" accept=".xlsx,.xls" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <button onclick="processExcelUpload()" class="px-6 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700">
              üìä PROSES EXCEL
            </button>
          </div>
          
          <div id="excelStatus" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>

        <div class="glass-panel p-8">
          <div class="flex justify-between items-center mb-6">
            <h3 class="heading-font text-2xl text-slate-800">Seksyen Laporan</h3>
            <button onclick="showAddSectionModal()" class="w-12 h-12 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-black hover:scale-105 transition text-2xl flex items-center justify-center" title="Tambah Seksyen">
              +
            </button>
          </div>

          <div id="sectionsList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Report Page -->
      <div id="reportPage" class="hidden">
        <div class="no-print mb-6 flex justify-end gap-3">
          <button onclick="window.print()" class="w-12 h-12 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition flex items-center justify-center" title="Print Laporan">
            <span class="material-symbols-outlined">print</span>
          </button>
          <button onclick="exportToWord()" class="w-12 h-12 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex items-center justify-center" title="Export ke Word">
            <span class="material-symbols-outlined">description</span>
          </button>
          <button onclick="exportToExcel()" class="w-12 h-12 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition flex items-center justify-center" title="Export ke Excel (CSV)">
            <span class="material-symbols-outlined">table_view</span>
          </button>
          <button onclick="saveToArchive()" class="w-12 h-12 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition flex items-center justify-center" title="Simpan ke Arkib">
            <span class="material-symbols-outlined">archive</span>
          </button>
        </div>

        <div class="report-page max-w-[1200px] mx-auto bg-white p-12 rounded-2xl shadow-2xl">
          <div class="report-header">
            <h1 id="reportHeader1">BAHAGIAN SIRKULASI</h1>
            <h2 id="reportHeader2">PERPUSTAKAAN HAMZAH SENDUT</h2>
            <h3 id="reportHeader3">LAPORAN BULANAN JANUARI 2026</h3>
          </div>

          <div id="reportContent"></div>
        </div>
      </div>

      <!-- Summary Page -->
      <div id="summaryPage" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="heading-font text-4xl text-white">üìä DATA TAHUNAN</h2>
          <select id="summaryYearSelect" onchange="renderSummary()" class="p-3 rounded-xl font-bold bg-white border-2 border-white">
          </select>
        </div>
        <div id="summaryContent" class="space-y-8"></div>
      </div>

      <!-- Archive Page -->
      <div id="archivePage" class="hidden">
        <h2 class="heading-font text-4xl text-white mb-8">üóÑÔ∏è ARKIB LAPORAN</h2>
        <div id="archiveList" class="grid gap-4"></div>
      </div>

      <!-- Users Management Page -->
      <div id="usersPage" class="hidden max-w-4xl mx-auto">
        <h2 class="heading-font text-4xl text-white mb-8">‚öôÔ∏è PENGURUSAN PENGGUNA</h2>
        
        <!-- Change Password (for current user) -->
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üîê Tukar Password</h3>
          <div class="grid grid-cols-3 gap-4">
            <input type="password" id="currentPassword" placeholder="Password semasa" class="p-3 border-2 border-slate-200 rounded-lg font-bold">
            <input type="password" id="newPasswordField" placeholder="Password baru" class="p-3 border-2 border-slate-200 rounded-lg font-bold">
            <button onclick="changePassword()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              TUKAR PASSWORD
            </button>
          </div>
        </div>
        
        <!-- Add New User (Admin only) -->
        <div class="glass-panel p-8 mb-6" id="addUserSection">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">‚ûï Tambah Pengguna Baru (Admin Sahaja)</h3>
          
          <div class="flex gap-4 mb-4">
            <input type="text" id="newUsername" placeholder="Username baru" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <input type="password" id="newPassword" placeholder="Password" class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold">
            <select id="newUserRole" class="p-3 border-2 border-slate-200 rounded-lg font-bold">
              <option value="viewer">Viewer</option>
              <option value="editor">Editor</option>
              <option value="admin">Admin</option>
            </select>
            <button onclick="addUser()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              + TAMBAH
            </button>
          </div>
        </div>
        
        <!-- Users List -->
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üë• Senarai Pengguna</h3>
          <div id="usersList" class="space-y-2"></div>
        </div>
        
        <!-- Activity Log -->
        <div class="glass-panel p-8">
          <h3 class="heading-font text-2xl text-slate-800 mb-6">üìã Log Aktiviti (50 Terkini)</h3>
          <div id="activityLogList" class="space-y-1 max-h-96 overflow-y-auto text-sm"></div>
        </div>
      </div>

    </main>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
    const sectionLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    
    // User authentication
    let users = JSON.parse(localStorage.getItem('phs_users')) || [
      { username: 'admin', password: 'admin123', role: 'admin' },
      { username: 'editor', password: 'edit123', role: 'editor' }
    ];
    let currentUser = null;
    let activityLog = JSON.parse(localStorage.getItem('phs_activity_log')) || [];
    
    let settings = JSON.parse(localStorage.getItem('phs_template_settings')) || {
      department: 'BAHAGIAN SIRKULASI',
      orgName: 'PERPUSTAKAAN HAMZAH SENDUT',
      month: 'Januari',
      year: '2026'
    };

    let sections = JSON.parse(localStorage.getItem('phs_template_sections')) || [];
    let persistentData = JSON.parse(localStorage.getItem('phs_template_persistent')) || {};
    let archive = JSON.parse(localStorage.getItem('phs_template_archive')) || [];

    function attemptLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      const user = users.find(u => u.username === username && u.password === password);
      
      if(user) {
        currentUser = user;
        logActivity(`${username} logged in as ${user.role}`);
        
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
        
        // Apply restrictions based on role
        if(user.role === 'viewer') {
          applyViewerRestrictions();
        } else if(user.role === 'editor') {
          applyEditorRestrictions();
        }
        
        init();
        setPage('dashboard-utama');
      } else {
        const errorDiv = document.getElementById('loginError');
        errorDiv.textContent = '‚ùå Username atau password salah!';
        errorDiv.classList.remove('hidden');
      }
    }
    
    function skipLoginAsViewer() {
      currentUser = { username: 'Guest Viewer', role: 'viewer' };
      logActivity('Guest viewer accessed system');
      
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      applyViewerRestrictions();
      init();
      setPage('dashboard-utama');
    }
    
    function logActivity(action) {
      const entry = {
        timestamp: new Date().toISOString(),
        user: currentUser?.username || 'Unknown',
        action: action
      };
      activityLog.unshift(entry);
      
      // Keep only last 100 entries
      if(activityLog.length > 100) {
        activityLog = activityLog.slice(0, 100);
      }
      
      localStorage.setItem('phs_activity_log', JSON.stringify(activityLog));
    }
    
    function applyViewerRestrictions() {
      // Hide navigation buttons except Dashboard and Data Tahunan
      const navButtons = {
        'nav-settings': true,
        'nav-report': true,
        'nav-archive': true,
        'nav-users': true
      };
      
      Object.keys(navButtons).forEach(id => {
        const btn = document.getElementById(id);
        if(btn) btn.style.display = 'none';
      });
      
      // Add a flag to check if user is viewer
      window.isViewer = true;
      
      // Redirect to dashboard if trying to access restricted pages
      setTimeout(() => {
        const currentPage = document.querySelector('main > div:not(.hidden)');
        if(currentPage) {
          const pageId = currentPage.id;
          if(pageId !== 'dashboard-utamaPage' && pageId !== 'summaryPage') {
            setPage('dashboard-utama');
          }
        }
      }, 100);
    }
    
    function applyEditorRestrictions() {
      // Editors can edit but not manage users
      const usersNav = document.getElementById('nav-users');
      if(usersNav) usersNav.style.display = 'none';
      
      window.isEditor = true;
    }
    
    function logout() {
      if(confirm('Log keluar dari sistem?')) {
        currentUser = null;
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      }
    }
    
    function addUser() {
      if(currentUser.role !== 'admin') {
        alert('Hanya admin boleh menambah pengguna!');
        return;
      }
      
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const role = document.getElementById('newUserRole').value;
      
      if(!username || !password) {
        alert('Sila isi username dan password!');
        return;
      }
      
      if(users.find(u => u.username === username)) {
        alert('Username sudah wujud!');
        return;
      }
      
      users.push({ username, password, role });
      localStorage.setItem('phs_users', JSON.stringify(users));
      logActivity(`Admin added new user: ${username} (${role})`);
      
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
      
      renderUsersList();
      alert('‚úÖ Pengguna berjaya ditambah!');
    }
    
    function delete