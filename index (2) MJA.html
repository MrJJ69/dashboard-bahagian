<!doctype html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashBoard Bahagian - Sistem Laporan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Outfit:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0047FF;
      --secondary: #FF3366;
      --accent: #00D9FF;
    }
    
    body { 
      font-family: 'Outfit', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment: fixed;
    }
    
    .heading-font { 
      font-family: 'Archivo Black', sans-serif; 
      letter-spacing: -0.03em;
    }
    
    .glass-panel {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 1.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .report-header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .report-header h1 {
      font-size: 1.5rem;
      font-weight: 900;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .report-header h2 {
      font-size: 1.25rem;
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }

    .report-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .section-container {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      page-break-inside: avoid;
    }

    .section-label {
      display: inline-block;
      background: linear-gradient(135deg, #0047FF, #00D9FF);
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 900;
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    th {
      background: #1e293b;
      color: white;
      padding: 0.75rem;
      text-align: center;
      font-weight: 800;
      font-size: 0.75rem;
      text-transform: uppercase;
      border: 1px solid #334155;
    }

    td {
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      text-align: center;
    }

    td:first-child {
      text-align: left;
      font-weight: 700;
    }

    .kumulatif-col {
      background: #fff7ed !important;
      color: #c2410c;
      font-weight: 900;
    }

    .jumlah-col {
      background: #fef3c7 !important;
      color: #a16207;
      font-weight: 900;
    }

    .jumlah-row {
      background: #fef3c7;
      border-top: 3px solid #a16207 !important;
    }

    .jumlah-row td {
      font-weight: 900;
      color: #a16207;
      border-top: 3px solid #a16207;
    }

    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      .section-container { 
        page-break-inside: avoid;
        page-break-after: always;
        box-shadow: none;
        margin-bottom: 0;
      }
      .section-container:last-child {
        page-break-after: auto;
      }
      .report-page {
        padding: 0;
      }
      .report-header {
        page-break-after: avoid;
        margin-bottom: 2rem;
      }
      /* Hide header on all pages except first */
      @page:first {
        margin-top: 0;
      }
    }

    input:focus, textarea:focus, select:focus { 
      background-color: #f0f7ff !important; 
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
  </style>
</head>
<body>

  <div id="app" class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-72 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 text-white flex-shrink-0 no-print border-r border-slate-700 shadow-2xl">
      <div class="p-8">
        <div class="mb-12">
          <h2 class="heading-font text-3xl mb-1 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-400">DashBoard</h2>
          <h3 class="heading-font text-2xl text-cyan-400">Bahagian</h3>
          <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mt-2">Sistem Laporan Bulanan</p>
        </div>
        
        <nav class="space-y-2">
          <button onclick="setPage('settings')" id="nav-settings" class="w-full text-left p-4 rounded-xl flex items-center gap-3 bg-gradient-to-r from-purple-600 to-pink-500 font-black text-sm">
            <span class="material-symbols-outlined">settings</span> TETAPAN
          </button>
          <button onclick="setPage('report')" id="nav-report" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">description</span> LAPORAN
          </button>
          <button onclick="setPage('summary')" id="nav-summary" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">table_chart</span> DATA TAHUNAN
          </button>
          <button onclick="setPage('archive')" id="nav-archive" class="w-full text-left p-4 rounded-xl flex items-center gap-3 hover:bg-slate-700/50 font-bold text-sm">
            <span class="material-symbols-outlined">archive</span> ARKIB
          </button>
        </nav>

        <div class="mt-12 p-6 bg-slate-800/50 rounded-xl border border-slate-700">
          <h4 class="text-xs font-black uppercase text-slate-400 mb-3">Info Sistem</h4>
          <div class="space-y-2 text-xs text-slate-300">
            <div>üìä Seksyen: <span id="sidebarSections" class="font-bold text-white">0</span></div>
            <div>üìÖ Bulan: <span id="sidebarMonth" class="font-bold text-cyan-400">-</span></div>
            <div>üíæ Arkib: <span id="sidebarArchive" class="font-bold text-white">0</span></div>
          </div>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8 overflow-y-auto">
      
      <!-- Settings Page -->
      <div id="settingsPage" class="max-w-4xl mx-auto">
        <h2 class="heading-font text-4xl text-white mb-8">‚öôÔ∏è TETAPAN ORGANISASI</h2>
        
        <div class="glass-panel p-8 mb-6">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Maklumat Header Laporan</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Bahagian / Unit</label>
              <input type="text" id="orgDepartment" value="BAHAGIAN SIRKULASI" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>
            
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">Nama Organisasi</label>
              <input type="text" id="orgName" value="PERPUSTAKAAN HAMZAH SENDUT" 
                     class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-lg"
                     oninput="saveSettings()">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Bulan</label>
                <select id="monthSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()"></select>
              </div>
              
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">Tahun</label>
                <select id="yearSelect" class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold" onchange="saveSettings(); renderReport()">
                  <option>2026</option><option>2025</option><option>2024</option>
                </select>
              </div>
            </div>
          </div>

          <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
            <div class="flex items-start gap-3">
              <span class="material-symbols-outlined text-blue-600">info</span>
              <div class="text-sm text-blue-800">
                <strong>Preview Header:</strong>
                <div class="mt-2 p-3 bg-white rounded border font-bold text-center">
                  <div id="headerPreview1">BAHAGIAN SIRKULASI</div>
                  <div id="headerPreview2">PERPUSTAKAAN HAMZAH SENDUT</div>
                  <div id="headerPreview3" class="text-blue-600">LAPORAN BULANAN JANUARI 2026</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass-panel p-8">
          <div class="flex justify-between items-center mb-6">
            <h3 class="heading-font text-2xl text-slate-800">Seksyen Laporan</h3>
            <button onclick="showAddSectionModal()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-black hover:scale-105 transition">
              <span class="material-symbols-outlined">add</span> TAMBAH SEKSYEN
            </button>
          </div>

          <div id="sectionsList" class="space-y-4"></div>
        </div>
      </div>

      <!-- Report Page -->
      <div id="reportPage" class="hidden">
        <div class="no-print mb-6 flex justify-end gap-3">
          <button onclick="window.print()" class="px-6 py-3 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition">
            <span class="material-symbols-outlined">print</span> PRINT
          </button>
          <button onclick="exportToExcel()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition">
            <span class="material-symbols-outlined">download</span> EXPORT EXCEL
          </button>
          <button onclick="saveToArchive()" class="px-6 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition">
            <span class="material-symbols-outlined">save</span> SIMPAN KE ARKIB
          </button>
        </div>

        <div class="report-page max-w-[1200px] mx-auto bg-white p-12 rounded-2xl shadow-2xl">
          <div class="report-header">
            <h1 id="reportHeader1">BAHAGIAN SIRKULASI</h1>
            <h2 id="reportHeader2">PERPUSTAKAAN HAMZAH SENDUT</h2>
            <h3 id="reportHeader3">LAPORAN BULANAN JANUARI 2026</h3>
          </div>

          <div id="reportContent"></div>
        </div>
      </div>

      <!-- Summary Page -->
      <div id="summaryPage" class="hidden">
        <h2 class="heading-font text-4xl text-white mb-8">üìä DATA TAHUNAN</h2>
        <div id="summaryContent" class="space-y-8"></div>
      </div>

      <!-- Archive Page -->
      <div id="archivePage" class="hidden">
        <h2 class="heading-font text-4xl text-white mb-8">üóÑÔ∏è ARKIB LAPORAN</h2>
        <div id="archiveList" class="grid gap-4"></div>
      </div>

    </main>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    const months = ["Januari", "Februari", "Mac", "April", "Mei", "Jun", "Julai", "Ogos", "September", "Oktober", "November", "Disember"];
    const sectionLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    
    let settings = JSON.parse(localStorage.getItem('phs_template_settings')) || {
      department: 'BAHAGIAN SIRKULASI',
      orgName: 'PERPUSTAKAAN HAMZAH SENDUT',
      month: 'Januari',
      year: '2026'
    };

    let sections = JSON.parse(localStorage.getItem('phs_template_sections')) || [];
    let persistentData = JSON.parse(localStorage.getItem('phs_template_persistent')) || {};
    let archive = JSON.parse(localStorage.getItem('phs_template_archive')) || [];

    function init() {
      // Setup month selector
      const mS = document.getElementById('monthSelect');
      months.forEach(m => mS.options.add(new Option(m, m)));
      mS.value = settings.month;
      document.getElementById('yearSelect').value = settings.year;

      // Load settings
      document.getElementById('orgDepartment').value = settings.department;
      document.getElementById('orgName').value = settings.orgName;

      updateHeaderPreview();
      renderSectionsList();
      updateSidebar();
    }

    function saveSettings() {
      settings.department = document.getElementById('orgDepartment').value;
      settings.orgName = document.getElementById('orgName').value;
      settings.month = document.getElementById('monthSelect').value;
      settings.year = document.getElementById('yearSelect').value;
      
      localStorage.setItem('phs_template_settings', JSON.stringify(settings));
      updateHeaderPreview();
      updateSidebar();
    }

    function autoSave() {
      localStorage.setItem('phs_template_sections', JSON.stringify(sections));
      localStorage.setItem('phs_template_persistent', JSON.stringify(persistentData));
      localStorage.setItem('phs_template_archive', JSON.stringify(archive));
      updateSidebar();
    }

    function updateHeaderPreview() {
      const preview1 = document.getElementById('headerPreview1');
      const preview2 = document.getElementById('headerPreview2');
      const preview3 = document.getElementById('headerPreview3');
      
      if(preview1) preview1.textContent = settings.department;
      if(preview2) preview2.textContent = settings.orgName;
      if(preview3) preview3.textContent = `LAPORAN BULANAN ${settings.month.toUpperCase()} ${settings.year}`;

      // Update report headers
      const h1 = document.getElementById('reportHeader1');
      const h2 = document.getElementById('reportHeader2');
      const h3 = document.getElementById('reportHeader3');
      if(h1) h1.textContent = settings.department;
      if(h2) h2.textContent = settings.orgName;
      if(h3) h3.textContent = `LAPORAN BULANAN ${settings.month.toUpperCase()} ${settings.year}`;
    }

    function updateSidebar() {
      document.getElementById('sidebarSections').textContent = sections.length;
      document.getElementById('sidebarMonth').textContent = settings.month;
      document.getElementById('sidebarArchive').textContent = archive.length;
    }

    function addSection(type = 'standard') {
      const newSection = {
        id: 'sec_' + Date.now(),
        title: 'TAJUK SEKSYEN',
        type: type, // 'standard', 'custom', 'ulasan-only'
        data: {},
        customColumns: [] // For custom table type
      };

      if(type === 'standard') {
        months.forEach(m => {
          newSection.data[m] = [
            { kategori: 'Category 1', val: 0 },
            { kategori: 'Category 2', val: 0 }
          ];
        });
      } else if(type === 'custom') {
        // Custom table like Section C (Pusat, Wilayah, etc.)
        newSection.customColumns = ['Pusat', 'Wilayah', 'Buku Diimbas', 'Oleh BS', 'Rekod daripada BSTM', 'Drop Record', 'MISSING'];
        months.forEach(m => {
          newSection.data[m] = [
            { kategori: 'Item 1', values: [0, 0, 0, 0, 0, 0, 0] }
          ];
        });
      }

      newSection.ulasan = {};
      months.forEach(m => newSection.ulasan[m] = '');

      sections.push(newSection);
      persistentData[newSection.id] = JSON.parse(JSON.stringify(newSection));
      
      renderSectionsList();
      autoSave();
    }

    function showAddSectionModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-2xl p-8">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Pilih Jenis Seksyen</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button onclick="addSection('standard'); this.closest('.fixed').remove();" 
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-blue-600 mb-3">table_chart</span>
              <div class="font-black text-lg mb-2">STANDARD</div>
              <div class="text-xs text-slate-600">Jadual + Graf + Ulasan</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen A, B)</div>
            </button>
            
            <button onclick="addSection('custom'); this.closest('.fixed').remove();" 
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-purple-600 mb-3">view_column</span>
              <div class="font-black text-lg mb-2">CUSTOM TABLE</div>
              <div class="text-xs text-slate-600">Kolum tersuai + Ulasan</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen C)</div>
            </button>
            
            <button onclick="addSection('ulasan-only'); this.closest('.fixed').remove();" 
                    class="p-6 border-3 border-slate-200 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition text-center">
              <span class="material-symbols-outlined text-5xl text-orange-600 mb-3">notes</span>
              <div class="font-black text-lg mb-2">ULASAN SAHAJA</div>
              <div class="text-xs text-slate-600">Tiada jadual/graf</div>
              <div class="text-xs text-slate-500 mt-2">(Seksyen D)</div>
            </button>
          </div>

          <button onclick="this.closest('.fixed').remove();" 
                  class="mt-6 w-full py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">
            BATAL
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function renderSectionsList() {
      const container = document.getElementById('sectionsList');
      container.innerHTML = '';

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="text-center p-12 border-2 border-dashed border-slate-300 rounded-xl">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">inbox</span>
            <p class="text-slate-500 font-bold">Tiada seksyen. Klik "TAMBAH SEKSYEN" untuk mula.</p>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "border-2 border-slate-200 rounded-xl p-4 hover:border-blue-400 transition";
        
        const typeBadges = {
          'standard': '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">üìä STANDARD</span>',
          'custom': '<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">üîß CUSTOM</span>',
          'ulasan-only': '<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">üí¨ ULASAN</span>'
        };
        
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4 flex-1">
              <div class="text-2xl font-black text-blue-600">${sectionLabels[idx]}.</div>
              <input value="${sec.title}" 
                     oninput="sections[${idx}].title = this.value; persistentData['${sec.id}'].title = this.value; autoSave();"
                     class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold text-lg hover:border-blue-300 transition">
              ${typeBadges[sec.type || 'standard']}
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="moveSection(${idx}, -1)" class="p-2 hover:bg-blue-50 rounded-lg transition" ${idx === 0 ? 'disabled opacity-30' : ''}>
                <span class="material-symbols-outlined text-blue-600">arrow_upward</span>
              </button>
              <button onclick="moveSection(${idx}, 1)" class="p-2 hover:bg-blue-50 rounded-lg transition" ${idx === sections.length-1 ? 'disabled opacity-30' : ''}>
                <span class="material-symbols-outlined text-blue-600">arrow_downward</span>
              </button>
              ${sec.type === 'custom' ? `<button onclick="editCustomColumns(${idx})" class="p-2 hover:bg-purple-50 rounded-lg transition" title="Edit Columns">
                <span class="material-symbols-outlined text-purple-600">view_column</span>
              </button>` : ''}
              <button onclick="deleteSection(${idx})" class="p-2 hover:bg-red-50 rounded-lg transition">
                <span class="material-symbols-outlined text-red-600">delete</span>
              </button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function moveSection(idx, dir) {
      if (idx + dir < 0 || idx + dir >= sections.length) return;
      [sections[idx], sections[idx+dir]] = [sections[idx+dir], sections[idx]];
      renderSectionsList();
      autoSave();
    }

    function deleteSection(idx) {
      if(confirm(`Padam seksyen "${sections[idx].title}"?\n\nData akan dipadam dari laporan dan data tahunan.`)) {
        const secId = sections[idx].id;
        sections.splice(idx, 1);
        delete persistentData[secId];
        renderSectionsList();
        autoSave();
      }
    }

    function renderReport() {
      const container = document.getElementById('reportContent');
      container.innerHTML = '';
      updateHeaderPreview();

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="text-center p-12">
            <p class="text-slate-500 font-bold text-lg">Tiada seksyen untuk dipaparkan.</p>
            <p class="text-slate-400 text-sm mt-2">Pergi ke TETAPAN untuk tambah seksyen.</p>
          </div>
        `;
        return;
      }

      const m = settings.month;
      const mIdx = months.indexOf(m);

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "section-container animate-in";
        div.style.animationDelay = `${idx * 0.1}s`;

        let content = '';

        // Header
        content += `
          <div class="flex justify-between items-start mb-4 no-print">
            <div class="section-label">${sectionLabels[idx]}. ${sec.title}</div>
          </div>
          <div class="print:block hidden mb-4">
            <div class="section-label">${sectionLabels[idx]}. ${sec.title}</div>
          </div>
        `;

        const secType = sec.type || 'standard';

        // STANDARD TYPE
        if(secType === 'standard') {
          let monthHeaders = '';
          for(let i = 0; i <= mIdx; i++) {
            monthHeaders += `<th>${months[i].toUpperCase()}</th>`;
          }

          const rows = sec.data[m].map((row, ri) => {
            let monthlyCols = '';
            let cumulative = 0;
            
            for(let i = 0; i <= mIdx; i++) {
              const val = getVal(sec.id, months[i], row.kategori);
              cumulative += val;
              monthlyCols += `<td><input type="number" value="${val}" 
                oninput="updateVal('${sec.id}', ${ri}, '${months[i]}', this.value)" 
                class="w-full text-center font-bold bg-transparent outline-none p-1"></td>`;
            }

            return `
              <tr>
                <td>
                  <input value="${row.kategori}" 
                         oninput="updateKategori('${sec.id}', ${ri}, this.value)"
                         class="w-full font-bold bg-transparent outline-none p-1">
                </td>
                ${monthlyCols}
                <td class="kumulatif-col">${cumulative}</td>
                <td class="no-print">
                  <button onclick="removeRow('${sec.id}', ${ri})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
                </td>
              </tr>
            `;
          }).join('');

          // Calculate JUMLAH row
          let jumlahRow = '<tr class="jumlah-row"><td class="font-black text-left">JUMLAH</td>';
          for(let i = 0; i <= mIdx; i++) {
            const monthTotal = sec.data[m].reduce((sum, row) => {
              return sum + getVal(sec.id, months[i], row.kategori);
            }, 0);
            jumlahRow += `<td class="jumlah-col">${monthTotal}</td>`;
          }
          // Kumulatif total
          const kumulatifTotal = sec.data[m].reduce((sum, row) => {
            let rowCumulative = 0;
            for(let i = 0; i <= mIdx; i++) {
              rowCumulative += getVal(sec.id, months[i], row.kategori);
            }
            return sum + rowCumulative;
          }, 0);
          jumlahRow += `<td class="jumlah-col">${kumulatifTotal}</td><td class="no-print"></td></tr>`;

          content += `
            <table>
              <thead>
                <tr>
                  <th class="text-left">KATEGORI</th>
                  ${monthHeaders}
                  <th class="bg-orange-700">KUMULATIF</th>
                  <th class="no-print w-10"></th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${jumlahRow}
              </tbody>
            </table>

            <button onclick="addRow('${sec.id}')" class="no-print mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">
              + TAMBAH BARIS
            </button>

            <div class="mt-6">
              <div class="h-72 bg-slate-50 p-4 rounded-xl border-2 mb-4">
                <canvas id="chart-${sec.id}"></canvas>
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">ULASAN</label>
                <textarea 
                  oninput="updateUlasan('${sec.id}', this.value)" 
                  class="w-full h-40 p-4 border-2 border-slate-200 rounded-xl resize-none"
                  placeholder="Tulis ulasan di sini...">${sec.ulasan[m] || ''}</textarea>
              </div>
            </div>
          `;
        }

        // CUSTOM TABLE TYPE
        else if(secType === 'custom') {
          const customCols = sec.customColumns || [];
          const colHeaders = customCols.map(col => `<th>${col}</th>`).join('');

          const rows = sec.data[m].map((row, ri) => {
            const vals = row.values || [];
            const cells = vals.map((v, ci) => `
              <td><input type="number" value="${v}" 
                    oninput="updateCustomVal('${sec.id}', ${ri}, ${ci}, this.value)"
                    class="w-full text-center font-bold bg-transparent outline-none p-1"></td>
            `).join('');

            return `
              <tr>
                <td>
                  <input value="${row.kategori}" 
                         oninput="updateKategori('${sec.id}', ${ri}, this.value)"
                         class="w-full font-bold bg-transparent outline-none p-1">
                </td>
                ${cells}
                <td class="no-print">
                  <button onclick="removeRow('${sec.id}', ${ri})" class="text-red-500 hover:text-red-700 font-bold text-xl">√ó</button>
                </td>
              </tr>
            `;
          }).join('');

          content += `
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th class="text-left">KATEGORI</th>
                    ${colHeaders}
                    <th class="no-print w-10"></th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>

            <div class="no-print flex gap-2 mt-2">
              <button onclick="addRowCustom('${sec.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700">
                + TAMBAH BARIS
              </button>
              <button onclick="editCustomColumns(${idx})" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-bold text-sm hover:bg-purple-700">
                <span class="material-symbols-outlined text-sm">edit</span> EDIT KOLUM
              </button>
            </div>

            <div class="mt-6">
              <label class="block text-sm font-bold text-slate-700 mb-2">ULASAN</label>
              <textarea 
                oninput="updateUlasan('${sec.id}', this.value)" 
                class="w-full h-40 p-4 border-2 border-slate-200 rounded-xl resize-none"
                placeholder="Tulis ulasan di sini...">${sec.ulasan[m] || ''}</textarea>
            </div>
          `;
        }

        // ULASAN ONLY TYPE
        else if(secType === 'ulasan-only') {
          content += `
            <div class="mt-4">
              <label class="block text-sm font-bold text-slate-700 mb-2">ULASAN</label>
              <textarea 
                oninput="updateUlasan('${sec.id}', this.value)" 
                class="w-full h-64 p-4 border-2 border-slate-200 rounded-xl resize-none"
                placeholder="Tulis ulasan dan maklumat tambahan di sini...">${sec.ulasan[m] || ''}</textarea>
            </div>
          `;
        }

        div.innerHTML = content;
        container.appendChild(div);
        
        if(secType === 'standard') {
          setTimeout(() => renderChart(sec), 100);
        }
      });
    }

    function getVal(secId, month, kategori) {
      const sec = persistentData[secId];
      if(!sec || !sec.data[month]) return 0;
      const row = sec.data[month].find(r => r.kategori === kategori);
      return row ? row.val : 0;
    }

    function updateVal(secId, rowIdx, month, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec && sec.data[month][rowIdx]) {
        sec.data[month][rowIdx].val = Number(val);
        persistentData[secId].data[month][rowIdx].val = Number(val);
        autoSave();
        renderReport();
      }
    }

    function updateKategori(secId, rowIdx, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        months.forEach(m => {
          if(sec.data[m][rowIdx]) {
            sec.data[m][rowIdx].kategori = val;
            persistentData[secId].data[m][rowIdx].kategori = val;
          }
        });
        autoSave();
      }
    }

    function updateUlasan(secId, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        sec.ulasan[settings.month] = val;
        persistentData[secId].ulasan[settings.month] = val;
        autoSave();
      }
    }

    function updateCustomVal(secId, rowIdx, colIdx, val) {
      const sec = sections.find(s => s.id === secId);
      if(sec && sec.data[settings.month][rowIdx]) {
        sec.data[settings.month][rowIdx].values[colIdx] = Number(val);
        persistentData[secId].data[settings.month][rowIdx].values[colIdx] = Number(val);
        autoSave();
      }
    }

    function addRowCustom(secId) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        const numCols = sec.customColumns.length;
        const newRow = { kategori: 'Item Baru', values: Array(numCols).fill(0) };
        months.forEach(m => {
          sec.data[m].push(JSON.parse(JSON.stringify(newRow)));
          persistentData[secId].data[m].push(JSON.parse(JSON.stringify(newRow)));
        });
        autoSave();
        renderReport();
      }
    }

    function editCustomColumns(idx) {
      const sec = sections[idx];
      const currentCols = sec.customColumns || [];
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-2xl p-8">
          <h3 class="heading-font text-2xl mb-6 text-slate-800">Edit Kolum Custom</h3>
          
          <div id="columnsList" class="space-y-2 mb-4"></div>
          
          <button onclick="addCustomColumn()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 mb-4">
            + TAMBAH KOLUM
          </button>

          <div class="flex gap-3">
            <button onclick="saveCustomColumns(${idx}); this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">
              SIMPAN
            </button>
            <button onclick="this.closest('.fixed').remove();" 
                    class="flex-1 py-3 bg-slate-200 hover:bg-slate-300 rounded-xl font-bold">
              BATAL
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      window.tempColumns = [...currentCols];
      renderColumnsList();
    }

    function renderColumnsList() {
      const container = document.getElementById('columnsList');
      if(!container) return;
      
      container.innerHTML = window.tempColumns.map((col, idx) => `
        <div class="flex items-center gap-2">
          <input value="${col}" 
                 oninput="window.tempColumns[${idx}] = this.value"
                 class="flex-1 p-3 border-2 border-slate-200 rounded-lg font-bold"
                 placeholder="Nama Kolum ${idx + 1}">
          <button onclick="window.tempColumns.splice(${idx}, 1); renderColumnsList();" 
                  class="p-3 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      `).join('');
    }

    function addCustomColumn() {
      window.tempColumns.push('Kolum Baru');
      renderColumnsList();
    }

    function saveCustomColumns(idx) {
      const sec = sections[idx];
      sec.customColumns = [...window.tempColumns];
      persistentData[sec.id].customColumns = [...window.tempColumns];
      
      // Resize all data rows
      months.forEach(m => {
        sec.data[m].forEach(row => {
          const oldLen = row.values.length;
          const newLen = sec.customColumns.length;
          if(newLen > oldLen) {
            row.values.push(...Array(newLen - oldLen).fill(0));
          } else if(newLen < oldLen) {
            row.values = row.values.slice(0, newLen);
          }
        });
        persistentData[sec.id].data[m] = JSON.parse(JSON.stringify(sec.data[m]));
      });
      
      autoSave();
      renderSectionsList();
      renderReport();
    }

    function addRow(secId) {
      const sec = sections.find(s => s.id === secId);
      if(sec) {
        months.forEach(m => {
          sec.data[m].push({ kategori: 'Kategori Baru', val: 0 });
          persistentData[secId].data[m].push({ kategori: 'Kategori Baru', val: 0 });
        });
        autoSave();
        renderReport();
      }
    }

    function removeRow(secId, rowIdx) {
      if(confirm('Padam baris ini?')) {
        const sec = sections.find(s => s.id === secId);
        if(sec) {
          months.forEach(m => {
            sec.data[m].splice(rowIdx, 1);
            persistentData[secId].data[m].splice(rowIdx, 1);
          });
          autoSave();
          renderReport();
        }
      }
    }

    function renderChart(sec) {
      const ctx = document.getElementById(`chart-${sec.id}`);
      if(!ctx) return;
      
      const m = settings.month;
      const data = sec.data[m] || [];
      
      new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: data.map(r => r.kategori),
          datasets: [{
            label: sec.title,
            data: data.map(r => r.val),
            backgroundColor: 'rgba(59, 130, 246, 0.8)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: 'end',
              align: 'top',
              font: { weight: 'bold', size: 14 },
              color: '#1d4ed8',
              formatter: (val) => val > 0 ? val : ''
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { weight: 'bold' } }
            },
            x: { 
              grid: { display: false },
              ticks: { font: { weight: 'bold' } }
            }
          }
        }
      });
    }

    function renderSummary() {
      const container = document.getElementById('summaryContent');
      container.innerHTML = '';

      if(sections.length === 0) {
        container.innerHTML = `
          <div class="glass-panel p-12 text-center">
            <p class="text-slate-500 font-bold">Tiada data untuk dipaparkan.</p>
          </div>
        `;
        return;
      }

      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = "glass-panel p-8 animate-in";
        div.style.animationDelay = `${idx * 0.1}s`;

        if(sec.type === 'ulasan-only') {
          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-4">${sectionLabels[idx]}. ${sec.title}</h3>
            <p class="text-slate-500 italic">Seksyen ini hanya mengandungi ulasan, tiada data jadual.</p>
          `;
          container.appendChild(div);
          return;
        }

        if(sec.type === 'custom') {
          // Custom table summary
          const customCols = sec.customColumns || [];
          const rows = sec.data["Januari"].map((r, ri) => {
            const kategori = r.kategori;
            const monthlyVals = months.map(m => {
              const mData = sec.data[m]?.find(row => row.kategori === kategori);
              return mData ? mData.values : Array(customCols.length).fill(0);
            });
            
            return `
              <tr class="hover:bg-slate-50">
                <td class="text-left font-bold">${kategori}</td>
                ${customCols.map((col, ci) => {
                  const monthVals = monthlyVals.map(vals => vals[ci]);
                  return monthVals.map(v => `<td>${v}</td>`).join('');
                }).join('')}
              </tr>
            `;
          }).join('');

          div.innerHTML = `
            <h3 class="heading-font text-2xl text-slate-800 mb-6">${sectionLabels[idx]}. ${sec.title} <span class="text-sm text-purple-600">(CUSTOM TABLE)</span></h3>
            <div class="overflow-x-auto">
              <table>
                <thead>
                  <tr>
                    <th class="text-left">KATEGORI</th>
                    ${customCols.map(col => months.map(m => `<th>${col}<br><span class="text-[8px]">${m.substring(0,3)}</span></th>`).join('')).join('')}
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
          container.appendChild(div);
          return;
        }

        // Standard table summary
        const rows = sec.data["Januari"].map((r, ri) => {
          const mVals = months.map(m => getVal(sec.id, m, r.kategori));
          const avg = (mVals.reduce((a,b) => a+b, 0) / 12).toFixed(1);

          return `
            <tr class="hover:bg-slate-50">
              <td class="text-left font-bold">${r.kategori}</td>
              ${mVals.map((v, i) => {
                const prev = i > 0 ? mVals[i-1] : v;
                const color = v > prev ? 'bg-green-50 text-green-700' : v < prev ? 'bg-red-50 text-red-700' : '';
                return `<td class="${color}">${v}</td>`;
              }).join('')}
              <td class="font-bold bg-blue-50 text-blue-700">${avg}</td>
            </tr>
          `;
        }).join('');

        // JUMLAH row for summary
        let jumlahRow = '<tr class="jumlah-row"><td class="text-left">JUMLAH</td>';
        months.forEach(m => {
          const monthTotal = sec.data["Januari"].reduce((sum, r) => {
            return sum + getVal(sec.id, m, r.kategori);
          }, 0);
          jumlahRow += `<td>${monthTotal}</td>`;
        });
        const grandTotal = sec.data["Januari"].reduce((sum, r) => {
          return sum + months.reduce((mSum, m) => mSum + getVal(sec.id, m, r.kategori), 0);
        }, 0);
        const avgTotal = (grandTotal / 12).toFixed(1);
        jumlahRow += `<td>${avgTotal}</td></tr>`;

        div.innerHTML = `
          <h3 class="heading-font text-2xl text-slate-800 mb-6">${sectionLabels[idx]}. ${sec.title}</h3>
          <div class="overflow-x-auto">
            <table>
              <thead>
                <tr>
                  <th class="text-left">KATEGORI</th>
                  ${months.map(m => `<th>${m.substring(0,3).toUpperCase()}</th>`).join('')}
                  <th class="bg-blue-800">PURATA</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
                ${jumlahRow}
              </tbody>
            </table>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function saveToArchive() {
      archive.push({
        id: Date.now(),
        month: settings.month,
        year: settings.year,
        department: settings.department,
        orgName: settings.orgName,
        sections: JSON.parse(JSON.stringify(sections)),
        timestamp: new Date().toLocaleString('ms-MY')
      });
      autoSave();
      alert('‚úÖ Laporan berjaya disimpan ke arkib!');
    }

    function renderArchive() {
      const container = document.getElementById('archiveList');
      container.innerHTML = '';

      if(archive.length === 0) {
        container.innerHTML = `
          <div class="glass-panel p-12 text-center">
            <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">archive</span>
            <p class="text-slate-500 font-bold">Tiada arkib.</p>
          </div>
        `;
        return;
      }

      archive.slice().reverse().forEach((item, idx) => {
        const realIdx = archive.length - 1 - idx;
        const div = document.createElement('div');
        div.className = "glass-panel p-6 flex justify-between items-center animate-in";
        div.style.animationDelay = `${idx * 0.05}s`;

        div.innerHTML = `
          <div>
            <h3 class="heading-font text-lg text-slate-800">${item.department}</h3>
            <p class="text-sm text-slate-600">${item.orgName}</p>
            <p class="text-sm text-blue-600 font-bold mt-1">üìÖ ${item.month} ${item.year}</p>
            <p class="text-xs text-slate-400 mt-1">üíæ ${item.timestamp}</p>
          </div>
          <div class="flex gap-2">
            <button onclick="loadArchive(${realIdx})" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">
              MUAT
            </button>
            <button onclick="deleteArchive(${realIdx})" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600">
              PADAM
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function loadArchive(idx) {
      if(confirm('Muat arkib ini? Data semasa akan diganti.')) {
        const item = archive[idx];
        settings.department = item.department;
        settings.orgName = item.orgName;
        settings.month = item.month;
        settings.year = item.year;
        sections = JSON.parse(JSON.stringify(item.sections));
        
        document.getElementById('orgDepartment').value = settings.department;
        document.getElementById('orgName').value = settings.orgName;
        document.getElementById('monthSelect').value = settings.month;
        document.getElementById('yearSelect').value = settings.year;
        
        saveSettings();
        renderSectionsList();
        setPage('settings');
      }
    }

    function deleteArchive(idx) {
      if(confirm('Padam arkib ini?')) {
        archive.splice(idx, 1);
        autoSave();
        renderArchive();
      }
    }

    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      
      sections.forEach((sec, idx) => {
        const data = [
          [`${sectionLabels[idx]}. ${sec.title}`],
          ['Kategori', ...months, 'JUMLAH'],
        ];
        
        sec.data["Januari"].forEach(r => {
          const row = [r.kategori];
          const mVals = months.map(m => getVal(sec.id, m, r.kategori));
          const total = mVals.reduce((a,b) => a+b, 0);
          row.push(...mVals, total);
          data.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, sec.title.substring(0, 31));
      });
      
      XLSX.writeFile(wb, `Laporan_${settings.month}_${settings.year}.xlsx`);
      alert('‚úÖ Excel berjaya di-export!');
    }

    function setPage(page) {
      document.querySelectorAll('main > div[id$="Page"]').forEach(d => d.classList.add('hidden'));
      document.getElementById(page + 'Page').classList.remove('hidden');
      
      document.querySelectorAll('nav button').forEach(b => {
        b.classList.remove('bg-gradient-to-r', 'from-purple-600', 'to-pink-500', 'from-blue-600', 'to-cyan-500');
        b.classList.add('hover:bg-slate-700/50');
      });
      
      const btn = document.getElementById('nav-' + page);
      btn.classList.remove('hover:bg-slate-700/50');
      
      if(page === 'settings') btn.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-500');
      else btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-cyan-500');
      
      if(page === 'report') renderReport();
      if(page === 'summary') renderSummary();
      if(page === 'archive') renderArchive();
    }

    init();
  </script>
</body>
</html>
